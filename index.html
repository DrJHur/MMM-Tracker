<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Mind Mirror (MMM)</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard-dynamic-subset.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #ACCAB2; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #f7f7f7; }

        /* Vintage Background Gradient */
        body {
            background: linear-gradient(135deg, #E6F0E8 0%, #FFF8E6 100%);
            background-attachment: fixed; 
            color: #78614D; /* Cafe Latte */
        }
        
        .font-sans { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
        canvas { width: 100% !important; height: 100% !important; }

        /* Custom Color Classes - Vintage Palette */
        .text-cafelatte { color: #78614D; }
        .border-cafelatte { border-color: #78614D; }
        
        /* PHQ-9: Darlington */
        .bg-darlington { background-color: #ACCAB2; }
        .text-darlington { color: #ACCAB2; }
        .hover-bg-darlington:hover { background-color: #9ABEA0; }
        
        /* GAD-7: Beeswax */
        .bg-beeswax { background-color: #E9A752; }
        .text-beeswax { color: #E9A752; }
        .hover-bg-beeswax:hover { background-color: #D99642; }

        /* PSS: Grenadine */
        .bg-grenadine { background-color: #D44726; }
        .text-grenadine { color: #D44726; }
        .hover-bg-grenadine:hover { background-color: #C03615; }

        /* Card Backgrounds */
        .phq-card-color { background-color: rgba(172, 202, 178, 0.15); }
        .gad-card-color { background-color: rgba(233, 167, 82, 0.15); }
        .pss-card-color { background-color: rgba(212, 71, 38, 0.1); }
    </style>
</head>
<body class="font-sans min-h-screen flex items-center justify-center p-4 relative overflow-y-auto">

    <div id="app" class="w-full max-w-4xl bg-white/90 backdrop-blur-sm shadow-xl rounded-2xl p-6 md:p-10 border border-[#ACCAB2]/30 relative z-10 my-8">

        <!-- Title -->
        <div class="relative mb-8 pt-4"> 
            <h1 class="text-3xl font-bold text-cafelatte mb-2 text-center relative z-10">My Mind Mirror, MMM (ìŒ-)</h1>
            <p class="text-sm text-cafelatte/80 text-center relative z-10">1ì£¼ì¼ì— í•œ ë²ˆì€ ê²€ì‚¬ë¥¼ ì§„í–‰í•˜ê³ , ìŒ- ê·¸ë ‡êµ¬ë‚˜,í•˜ê³  ìê¸° ë§ˆìŒì„ ì•Œì•„ì£¼ì„¸ìš”.</p>
        </div>

        <!-- User Info -->
        <div class="mb-6 flex justify-between items-center text-sm border-b border-gray-200 pb-4">
            <div id="user-info" class="text-cafelatte flex items-center space-x-4">
                <p>ì‚¬ìš©ì ID: <span id="display-user-id" class="font-mono text-xs bg-[#E6F0E8] px-2 py-1 rounded text-cafelatte">ì¸ì¦ í•„ìš”</span></p>
                <p>ìƒíƒœ: <span id="auth-status" class="font-semibold text-grenadine">ë¡œë“œ ì¤‘...</span></p>
                <button id="signout-button" class="hidden text-xs px-3 py-1 bg-grenadine text-white rounded-lg hover:bg-[#C03615] transition ml-4 shadow-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="loading-indicator" class="hidden flex items-center space-x-2 text-beeswax">
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>ì²˜ë¦¬ ì¤‘...</span>
            </div>
        </div>

        <!-- Login Form -->
        <div id="auth-blocker" class="mb-8 p-6 bg-[#FFF8E6] border border-beeswax/30 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg text-cafelatte mb-2">íšŒì›ê°€ì…/ë¡œê·¸ì¸ í•„ìš”</h3>
            <p class="text-cafelatte/80 mb-4 text-sm">ê°œì¸ ì •ë³´ì˜ ì•ˆì „í•œ ì €ì¥ì„ ìœ„í•´ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ íšŒì›ê°€ì…, ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.</p>
            
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" required class="w-full p-3 mb-3 border border-[#ACCAB2] rounded-lg text-cafelatte bg-white/80 placeholder-cafelatte/50 focus:outline-none focus:ring-2 focus:ring-[#ACCAB2]">
                <input type="password" id="auth-password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" required class="w-full p-3 mb-4 border border-[#ACCAB2] rounded-lg text-cafelatte bg-white/80 placeholder-cafelatte/50 focus:outline-none focus:ring-2 focus:ring-[#ACCAB2]">
                <div class="flex justify-between items-center">
                    <button type="submit" id="auth-submit-button" data-mode="signin" class="px-6 py-2 bg-beeswax text-white font-bold rounded-lg hover-bg-beeswax transition shadow-md">ë¡œê·¸ì¸</button>
                    <a href="#" id="auth-mode-toggle" class="text-sm text-grenadine hover:underline transition font-medium">íšŒì›ê°€ì… í•˜ê¸°</a>
                </div>
            </form>
        </div>

        <!-- Buttons with Vintage Colors -->
        <div id="assessment-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <button data-scale="PHQ9" class="p-4 rounded-xl text-white font-bold shadow-md transition-transform transform hover:scale-[1.02] bg-darlington hover-bg-darlington disabled:opacity-50 disabled:cursor-not-allowed" disabled>PHQ-9 (ìš°ìš¸) ì¸¡ì •</button>
            <button data-scale="GAD7" class="p-4 rounded-xl text-white font-bold shadow-md transition-transform transform hover:scale-[1.02] bg-beeswax hover-bg-beeswax disabled:opacity-50 disabled:cursor-not-allowed" disabled>GAD-7 (ë¶ˆì•ˆ) ì¸¡ì •</button>
            <button data-scale="PSS" class="p-4 rounded-xl text-white font-bold shadow-md transition-transform transform hover:scale-[1.02] bg-grenadine hover-bg-grenadine disabled:opacity-50 disabled:cursor-not-allowed" disabled>PSS (ìŠ¤íŠ¸ë ˆìŠ¤) ì¸¡ì •</button>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden px-4 py-3 rounded-xl mb-6 shadow-sm" role="alert">
            <strong id="message-title" class="font-bold"></strong> <span id="message-text"></span>
        </div>

        <!-- Charts -->
        <div class="bg-white p-6 rounded-xl border border-[#ACCAB2]/30 shadow-sm">
            <h2 class="text-xl font-semibold text-cafelatte mb-6 text-center">ë‚˜ì˜ MMM (ìŒ-) í”„ë¡œíŒŒì¼</h2>
            <div id="chart-caption" class="text-center text-xs text-cafelatte/60 mb-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¸¡ì •ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”!</div>

            <div class="space-y-10">
                <div class="p-5 rounded-xl bg-white border border-[#ACCAB2]/20 shadow-sm">
                    <h3 class="font-bold text-lg text-darlington mb-3">ìš°ìš¸ì˜ ì›€ì§ì„ (PHQ-9)</h3>
                    <div class="relative h-48 md:h-64"><canvas id="phqChart"></canvas></div>
                </div>
                <div class="p-5 rounded-xl bg-white border border-[#E9A752]/20 shadow-sm">
                    <h3 class="font-bold text-lg text-beeswax mb-3">ë¶ˆì•ˆì˜ ì›€ì§ì„ (GAD-7)</h3>
                    <div class="relative h-48 md:h-64"><canvas id="gadChart"></canvas></div>
                </div>
                <div class="p-5 rounded-xl bg-white border border-[#D44726]/20 shadow-sm">
                    <h3 class="font-bold text-lg text-grenadine mb-3">ë‚´ê°€ ëŠë¼ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ (PSS)</h3>
                    <div class="relative h-48 md:h-64"><canvas id="pssChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-cafelatte mb-4">ìµœê·¼ ì¸¡ì • ìš”ì•½</h2>
            <div id="latest-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-5 phq-card-color rounded-xl shadow-sm border border-[#ACCAB2]/20">
                    <p class="font-bold text-lg text-darlington">PHQ-9</p>
                    <p class="text-3xl font-extrabold text-cafelatte" id="latest-phq">--</p>
                    <p class="text-xs text-cafelatte/70">ìš°ìš¸ ì ìˆ˜ (ìµœëŒ€ 27ì )</p>
                </div>
                <div class="p-5 gad-card-color rounded-xl shadow-sm border border-[#E9A752]/20">
                    <p class="font-bold text-lg text-beeswax">GAD-7</p>
                    <p class="text-3xl font-extrabold text-cafelatte" id="latest-gad">--</p>
                    <p class="text-xs text-cafelatte/70">ë¶ˆì•ˆ ì ìˆ˜ (ìµœëŒ€ 21ì )</p>
                </div>
                <div class="p-5 pss-card-color rounded-xl shadow-sm border border-[#D44726]/20">
                    <p class="font-bold text-lg text-grenadine">PSS</p>
                    <p class="text-3xl font-extrabold text-cafelatte" id="latest-pss">--</p>
                    <p class="text-xs text-cafelatte/70">ìŠ¤íŠ¸ë ˆìŠ¤ ì ìˆ˜ (ìµœëŒ€ 40ì )</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="assessment-modal" class="hidden fixed inset-0 bg-[#78614D]/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-300">
            <div id="modal-header" class="p-6 text-white text-xl font-bold rounded-t-xl"><span id="scale-title"></span> ì¸¡ì •</div>
            <div class="p-6 custom-scrollbar max-h-[70vh] overflow-y-auto"><form id="assessment-form"></form></div>
            <div class="p-4 border-t border-gray-100 flex justify-end space-x-3 bg-gray-50">
                <button id="cancel-assessment" type="button" class="px-4 py-2 bg-gray-200 text-cafelatte rounded-lg">ì·¨ì†Œ</button>
                <button id="submit-assessment" type="submit" form="assessment-form" class="px-4 py-2 text-white rounded-lg font-bold">ê²°ê³¼ ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'my-mind-mirror-mmm-prod'; 
        // ğŸš¨ ë³¸ì¸ì˜ Firebase ì„¤ì •ìœ¼ë¡œ êµì²´
        const firebaseConfig = {
            apiKey: "AIzaSyDJ5lpzMYtQP_TrfqXQDF9QTmAVYNU84kE",
            authDomain: "mmm-project-13fb3.firebaseapp.com",
            projectId: "mmm-project-13fb3",
            storageBucket: "mmm-project-13fb3.firebasestorage.app",
            messagingSenderId: "845948284004",
            appId: "1:845948284004:web:aec6d670eb1e656a5a0371",
            measurementId: "G-3TJ21YRM59"
        };

        let app, db, auth, userId = null;
        let phqChartInstance = null, gadChartInstance = null, pssChartInstance = null;
        let scaleData = null;
        
        // Vintage Palette Colors for Charts
        const CHART_COLORS = {
            PHQ9: { color: '#ACCAB2', bgColor: 'transparent' }, // Darlington
            GAD7: { color: '#E9A752', bgColor: 'transparent' }, // Beeswax
            PSS: { color: '#D44726', bgColor: 'transparent' } // Grenadine
        };

        const CHART_CONFIGS = {
            PHQ9: { id: 'phqChart', label: 'PHQ-9 (ìš°ìš¸)', maxScore: 27, prop: 'phq9', instance: 'phqChartInstance', ...CHART_COLORS.PHQ9 },
            GAD7: { id: 'gadChart', label: 'GAD-7 (ë¶ˆì•ˆ)', maxScore: 21, prop: 'gad7', instance: 'gadChartInstance', ...CHART_COLORS.GAD7 },
            PSS: { id: 'pssChart', label: 'PSS (ìŠ¤íŠ¸ë ˆìŠ¤)', maxScore: 40, prop: 'pss', instance: 'pssChartInstance', ...CHART_COLORS.PSS }
        };

        const responseOptionsPHQGAD = [{value:0,text:"ì „í˜€ ì—†ìŒ"},{value:1,text:"ëª‡ ì¼"},{value:2,text:"ì¼ì£¼ì¼ì— ë°˜ ì´ìƒ"},{value:3,text:"ê±°ì˜ ë§¤ì¼"}];
        const responseOptionsPSS = [{value:0,text:"ì „í˜€ ì—†ë‹¤"},{value:1,text:"ê±°ì˜ ì—†ë‹¤"},{value:2,text:"ë•Œë•Œë¡œ ìˆë‹¤"},{value:3,text:"ìì£¼ ìˆë‹¤"},{value:4,text:"ë§¤ìš° ìì£¼ ìˆë‹¤"}];
        const reverseScoreMap = {0:4,1:3,2:2,3:1,4:0};
        
        const assessments = {
            PHQ9: { title: "PHQ-9 (ìš°ìš¸ì¦ ì„ ë³„ ë„êµ¬)", colorClass: 'bg-darlington', hoverClass: 'hover-bg-darlington', options: responseOptionsPHQGAD, questions: ["ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ë‹¤ìŒ ë¬¸ì œë“¤ë¡œ ì¸í•´ ì–¼ë§ˆë‚˜ ìì£¼ ë¶ˆí¸ì„ ê²ªìœ¼ì…¨ìŠµë‹ˆê¹Œ?", "1. ì¼ì— í¥ë¯¸ë‚˜ ì¦ê±°ì›€ì´ ê±°ì˜ ì—†ì—ˆë‹¤.", "2. ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, í¬ë§ì´ ì—†ë‹¤ê³  ëŠê¼ˆë‹¤.", "3. ì ë“¤ê±°ë‚˜ ê³„ì† ì ì„ ìëŠ” ë° ì–´ë ¤ì›€ì´ ìˆê±°ë‚˜, ë„ˆë¬´ ë§ì´ ì¤ë‹¤.", "4. í”¼ê³¤í•˜ê±°ë‚˜ ê¸°ë ¥ì´ ê±°ì˜ ì—†ì—ˆë‹¤.", "5. ì‹ìš•ì´ ì—†ê±°ë‚˜ ê³¼ì‹í–ˆë‹¤.", "6. ìì‹ ì„ ì‹¤íŒ¨ìë¼ê³  ëŠë¼ê±°ë‚˜, ìì‹ ì´ë‚˜ ê°€ì¡±ì„ ì‹¤ë§ì‹œì¼°ë‹¤ê³  ëŠê¼ˆë‹¤.", "7. ì‹ ë¬¸ ì½ê¸°ë‚˜ TV ì‹œì²­ì²˜ëŸ¼ í‰ì†Œë³´ë‹¤ ëŠë¦¬ê²Œ ì›€ì§ì´ê±°ë‚˜ ë§ì„ í–ˆê³ , ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ì•Œì•„ì±Œ ì •ë„ì˜€ë‹¤. ë˜ëŠ” ì´ì™€ ë°˜ëŒ€ë¡œ ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆëª»í•´ì„œ í‰ì†Œë³´ë‹¤ ë§ì´ ì›€ì§ì˜€ë‹¤.", "8. ì§‘ì¤‘í•˜ê¸°ê°€ ì–´ë µë‹¤(ì˜ˆ: ì‹ ë¬¸ ì½ê¸°, TV ì‹œì²­ ì‹œ).", "9. ì§€ë‚œ 2ì£¼ ë™ì•ˆ ì´ ë¬¸ì œë“¤ë¡œ ì¸í•´ ì§ì¥/í•™ì—…, ê°€ì • ìƒí™œ, ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„ì—ì„œ ì–´ë ¤ì›€ì´ ìˆì—ˆë‹¤ë©´ ì–¼ë§ˆë‚˜ ì‹¬ê°í–ˆìŠµë‹ˆê¹Œ?"].slice(0, 10) },
            GAD7: { title: "GAD-7 (ë²”ë¶ˆì•ˆì¥ì•  ì„ ë³„ ë„êµ¬)", colorClass: 'bg-beeswax', hoverClass: 'hover-bg-beeswax', options: responseOptionsPHQGAD, questions: ["ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ë‹¤ìŒ ë¬¸ì œë“¤ë¡œ ì¸í•´ ì–¼ë§ˆë‚˜ ìì£¼ ë¶ˆí¸ì„ ê²ªìœ¼ì…¨ìŠµë‹ˆê¹Œ?", "1. ì•ˆì ˆë¶€ì ˆëª»í•˜ê±°ë‚˜ í‰ì˜¨í•˜ê²Œ ìˆì„ ìˆ˜ ì—†ì—ˆë‹¤.", "2. ì‰½ê²Œ ì§œì¦ì„ ë‚´ê±°ë‚˜ ì‹ ê²½ì´ ê³¤ë‘ì„œ ìˆì—ˆë‹¤.", "3. ë¬´ì—‡ì¸ê°€ ê±±ì •í•˜ëŠ” ê²ƒì„ ë©ˆì¶œ ìˆ˜ ì—†ê±°ë‚˜ ì¡°ì ˆí•  ìˆ˜ ì—†ì—ˆë‹¤.", "4. ì§€ë‚˜ì¹˜ê²Œ ê±±ì •í–ˆë‹¤.", "5. ì—¬ëŸ¬ ê°€ì§€ ì¼ì— ëŒ€í•´ ë„ˆë¬´ ê±±ì •í–ˆë‹¤.", "6. ë¶ˆì•ˆ ë•Œë¬¸ì— íœ´ì‹ì„ ì·¨í•˜ê¸° ì–´ë ¤ì› ë‹¤.", "7. ë„ˆë¬´ ê±±ì •ë˜ì–´ì„œ ì ë“¤ê¸°ê°€ ì–´ë ¤ì› ë‹¤."] },
            PSS: { title: "PSS-10 (ì§€ê°ëœ ìŠ¤íŠ¸ë ˆìŠ¤ ì²™ë„)", colorClass: 'bg-grenadine', hoverClass: 'hover-bg-grenadine', options: responseOptionsPSS, questions: ["ì§€ë‚œ í•œ ë‹¬ ë™ì•ˆ, ë‹¤ìŒ ê° ì§ˆë¬¸ì˜ ìƒí™©ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆëŠ”ì§€ ì‘ë‹µí•´ ì£¼ì‹­ì‹œì˜¤. (10ë¬¸í•­)", "1. ì˜ˆê¸°ì¹˜ ì•Šì€ ì¼ë“¤ ë•Œë¬¸ì— ë‹¹í™©í–ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "2. ìƒí™œì˜ ì¤‘ìš”í•œ ì¼ë“¤ì„ í†µì œí•  ìˆ˜ ì—†ë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "3. ì‹ ê²½ì´ ì˜ˆë¯¼í•´ì§€ê³  ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•˜ë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "4. ìƒí™œ ì†ì—ì„œ ì¼ì–´ë‚˜ëŠ” ì¼ë“¤ì„ ì²˜ë¦¬í•˜ëŠ” ë° íš¨ê³¼ì ìœ¼ë¡œ ëŒ€ì²˜í•œë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "5. ë‹¹ì‹ ì—ê²Œ ì¤‘ìš”í•œ ì¼ë“¤ì„ ì™„ë²½í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "6. ë‹¹ì‹ ì´ í†µì œí•  ìˆ˜ ì—†ì—ˆë˜ ì¼ë“¤ ë•Œë¬¸ì— í™”ê°€ ë‚¬ë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "7. ì‚¬ì†Œí•œ ì¼ë“¤ì— ëŒ€í•´ ì„±ê³µì ìœ¼ë¡œ ëŒ€ì²˜í•œë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "8. ìŒ“ì—¬ ìˆëŠ” ì¼ë“¤ì„ ì˜ ì²˜ë¦¬í•˜ê³  ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "9. ë‹¹ì‹ ì´ ê°ë‹¹í•  ìˆ˜ ì—†ì„ ì •ë„ë¡œ ë§ì€ ì¼ë“¤ì´ ìŒ“ì—¬ ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "10. ë‹¹ì‹ ì˜ ê°œì¸ì ì¸ ì¼ë“¤ì´ ê³„íšëŒ€ë¡œ ì§„í–‰ë˜ê³  ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?"], reverseIndices: [4, 5, 7, 8, 10] }
        };

        function toggleAppFeatures(enable) {
            const buttons = document.querySelectorAll('#assessment-buttons button');
            buttons.forEach(btn => btn.disabled = !enable);
            const blocker = document.getElementById('auth-blocker');
            const signoutButton = document.getElementById('signout-button');
            if (enable) { blocker.classList.add('hidden'); signoutButton.classList.remove('hidden'); } 
            else { blocker.classList.remove('hidden'); signoutButton.classList.add('hidden'); }
        }
        
        function displayMessage(type, message) {
            const box = document.getElementById('message-box');
            const title = document.getElementById('message-title');
            const text = document.getElementById('message-text');
            box.className = 'px-4 py-3 rounded-xl mb-6 shadow-sm'; title.className = 'font-bold'; text.className = 'block sm:inline';
            if (type === 'error') { box.classList.add('bg-grenadine/10', 'border', 'border-grenadine/50', 'text-grenadine'); title.textContent = 'ì˜¤ë¥˜ ë°œìƒ:'; } 
            else if (type === 'success') { box.classList.add('bg-darlington/20', 'border', 'border-darlington', 'text-cafelatte'); title.textContent = 'ì•Œë¦¼:'; } 
            else { box.classList.add('bg-beeswax/20', 'border', 'border-beeswax', 'text-cafelatte'); title.textContent = 'ì •ë³´:'; }
            text.textContent = message; box.classList.remove('hidden'); setTimeout(() => box.classList.add('hidden'), 8000);
        }

        async function signInUser(email, password) {
            showLoading(true);
            try { await signInWithEmailAndPassword(auth, email, password); displayMessage('success', "ë¡œê·¸ì¸ ì„±ê³µ!"); } 
            catch (error) { console.error(error); displayMessage('error', `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`); } 
            finally { showLoading(false); }
        }

        async function signUpUser(email, password) {
            showLoading(true);
            try { await createUserWithEmailAndPassword(auth, email, password); displayMessage('success', "íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ ì™„ë£Œ!"); } 
            catch (error) { console.error(error); displayMessage('error', `íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message}`); } 
            finally { showLoading(false); }
        }
        
        function handleSignOut() {
            showLoading(true);
            signOut(auth).then(() => { displayMessage('success', "ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤."); }).catch((error) => { displayMessage('error', "ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜"); }).finally(() => { showLoading(false); });
        }
        
        async function initFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.getElementById('auth-status').textContent = 'ì„¤ì • ì˜¤ë¥˜';
                displayMessage('error', "Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); toggleAppFeatures(false); return;
            }
            try {
                setLogLevel('error'); app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                document.getElementById('auth-status').textContent = 'ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...';
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; document.getElementById('auth-status').textContent = `ì¸ì¦ ì™„ë£Œ`; document.getElementById('display-user-id').textContent = userId; toggleAppFeatures(true); setupRealtimeListener(); } 
                    else { userId = null; document.getElementById('auth-status').textContent = 'ë¡œê·¸ì¸ í•„ìš”'; document.getElementById('display-user-id').textContent = 'ì¸ì¦ í•„ìš”'; toggleAppFeatures(false); updateCharts([]); updateSummary([]); }
                });
            } catch (error) { console.error(error); displayMessage('error', "Firebase ì´ˆê¸°í™” ì‹¤íŒ¨"); toggleAppFeatures(false); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('auth-form');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authModeToggle = document.getElementById('auth-mode-toggle');
            if(authForm) {
                authForm.addEventListener('submit', function(e) { e.preventDefault(); const email = document.getElementById('auth-email').value; const password = document.getElementById('auth-password').value; const mode = authSubmitButton.dataset.mode; if (mode === 'signin') { signInUser(email, password); } else { signUpUser(email, password); } });
                authModeToggle.addEventListener('click', function(e) { e.preventDefault(); if (authSubmitButton.dataset.mode === 'signin') { authSubmitButton.dataset.mode = 'signup'; authSubmitButton.textContent = 'íšŒì›ê°€ì…'; authModeToggle.textContent = 'ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°'; } else { authSubmitButton.dataset.mode = 'signin'; authSubmitButton.textContent = 'ë¡œê·¸ì¸'; authModeToggle.textContent = 'íšŒì›ê°€ì… í•˜ê¸°'; } });
            }
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            initFirebase();
        });
        
        function getCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/stress_trackers`);
        }

        function setupRealtimeListener() {
            const colRef = getCollectionRef(); if (!colRef) return;
            onSnapshot(colRef, (snapshot) => {
                const results = []; snapshot.forEach((doc) => { results.push({ id: doc.id, ...doc.data() }); });
                results.sort((a, b) => (a.timestamp ? a.timestamp.toDate() : 0) - (b.timestamp ? b.timestamp.toDate() : 0));
                scaleData = results; updateCharts(scaleData); updateSummary(scaleData);
            }, (error) => { console.error(error); displayMessage('error', "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜"); });
        }
        
        async function saveAssessmentResult(result) {
            const colRef = getCollectionRef(); if (!colRef) { displayMessage('error', "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
            showLoading(true);
            try { await addDoc(colRef, { ...result, timestamp: serverTimestamp() }); displayMessage('success', "ì €ì¥ ì™„ë£Œ!"); } 
            catch (error) { console.error(error); displayMessage('error', "ì €ì¥ ì‹¤íŒ¨"); } 
            finally { showLoading(false); }
        }
        
        function createOrUpdateChart(chartId, dataLabels, scoreData, config) {
            const ctx = document.getElementById(chartId).getContext('2d');
            let instance;
            if (config.instance === 'phqChartInstance') instance = phqChartInstance;
            else if (config.instance === 'gadChartInstance') instance = gadChartInstance;
            else if (config.instance === 'pssChartInstance') instance = pssChartInstance;

            if (instance) { 
                instance.data.labels = dataLabels; 
                instance.data.datasets[0].data = scoreData;
                instance.data.datasets[0].showLine = scoreData.filter(v => v !== null).length > 1;
                instance.update(); return instance; 
            }

            const shouldShowLine = scoreData.filter(v => v !== null).length > 1;
            const newInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataLabels,
                    datasets: [{
                        label: config.label, 
                        data: scoreData, 
                        borderColor: config.color, 
                        backgroundColor: 'transparent',
                        tension: 0.4, 
                        fill: false, 
                        pointBackgroundColor: config.color, 
                        pointBorderColor: '#fff', 
                        pointBorderWidth: 2, 
                        pointRadius: 6, 
                        pointHoverRadius: 8,
                        showLine: shouldShowLine 
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true } },
                    elements: { line: { tension: 0.4 }, point: { pointStyle: 'circle' } },
                    scales: { y: { beginAtZero: true, max: config.maxScore, title: { display: true, text: 'ì ìˆ˜' }, ticks: { precision: 0 } }, x: { type: 'category', title: { display: true, text: 'ì¸¡ì • ì‹œì ' }, ticks: { autoSkip: true, maxTicksLimit: 7 } } }
                }
            });
            
            if (config.instance === 'phqChartInstance') phqChartInstance = newInstance;
            else if (config.instance === 'gadChartInstance') gadChartInstance = newInstance;
            else if (config.instance === 'pssChartInstance') pssChartInstance = newInstance;
            return newInstance;
        }

        function updateCharts(data) {
            if (data.length === 0) {
                document.getElementById('chart-caption').textContent = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¸¡ì •ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”!";
                if(phqChartInstance) { phqChartInstance.destroy(); phqChartInstance = null; }
                if(gadChartInstance) { gadChartInstance.destroy(); gadChartInstance = null; }
                if(pssChartInstance) { pssChartInstance.destroy(); pssChartInstance = null; }
                return;
            }
            document.getElementById('chart-caption').textContent = `ì´ ${data.length}ê±´ì˜ ì¸¡ì • ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.`;
            const labels = data.map(item => {
                if (item.timestamp) {
                    const date = item.timestamp.toDate();
                    const year = String(date.getFullYear()).slice(-2); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}/${month}/${day} ${hours}:${minutes}`;
                } return 'N/A';
            });
            const phqScores = data.map(item => item.phq9 || null);
            const gadScores = data.map(item => item.gad7 || null);
            const pssScores = data.map(item => item.pss || null);
            createOrUpdateChart(CHART_CONFIGS.PHQ9.id, labels, phqScores, CHART_CONFIGS.PHQ9);
            createOrUpdateChart(CHART_CONFIGS.GAD7.id, labels, gadScores, CHART_CONFIGS.GAD7);
            createOrUpdateChart(CHART_CONFIGS.PSS.id, labels, pssScores, CHART_CONFIGS.PSS);
        }

        function updateSummary(data) {
            const latestScores = { phq9: '--', gad7: '--', pss: '--' };
            for (let i = data.length - 1; i >= 0; i--) {
                const item = data[i];
                if (latestScores.phq9 === '--' && item.phq9 !== undefined) latestScores.phq9 = item.phq9;
                if (latestScores.gad7 === '--' && item.gad7 !== undefined) latestScores.gad7 = item.gad7;
                if (latestScores.pss === '--' && item.pss !== undefined) latestScores.pss = item.pss;
                if (latestScores.phq9 !== '--' && latestScores.gad7 !== '--' && latestScores.pss !== '--') break;
            }
            document.getElementById('latest-phq').textContent = latestScores.phq9;
            document.getElementById('latest-gad').textContent = latestScores.gad7;
            document.getElementById('latest-pss').textContent = latestScores.pss;
        }

        let currentScale = '';
        function openAssessmentModal(scale) {
            if (!userId) { displayMessage('error', "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); return; }
            currentScale = scale; const assessment = assessments[scale];
            document.getElementById('scale-title').textContent = assessment.title.split(' ')[0];
            const header = document.getElementById('modal-header');
            ['bg-darlington', 'bg-beeswax', 'bg-grenadine'].forEach(c => header.classList.remove(c));
            header.classList.add(assessment.colorClass);
            const submitButton = document.getElementById('submit-assessment');
            ['bg-darlington', 'bg-beeswax', 'bg-grenadine'].forEach(c => submitButton.classList.remove(c));
            submitButton.classList.add(assessment.colorClass);
            
             const hoverClasses = ['hover-bg-darlington', 'hover-bg-beeswax', 'hover-bg-grenadine'];
             hoverClasses.forEach(c => submitButton.classList.remove(c));
             submitButton.classList.add(assessment.hoverClass);

            const form = document.getElementById('assessment-form'); form.innerHTML = '';
            let introText = `<p class="text-cafelatte mb-4">${assessment.questions[0]}</p>`; form.insertAdjacentHTML('beforeend', introText);
            const questionsToRender = scale === 'PHQ9' ? assessment.questions.slice(1, 10) : assessment.questions.slice(1);
            questionsToRender.forEach((questionText, index) => {
                const qNum = index + 1;
                let questionHtml = `<div class="mb-5 p-4 border border-[#ACCAB2]/30 rounded-lg shadow-sm"><p class="font-semibold text-cafelatte mb-3">${questionText}</p><div class="space-y-2">`;
                assessment.options.forEach(option => {
                    const uniqueId = `${scale}-q${qNum}-v${option.value}`;
                    questionHtml += `<label for="${uniqueId}" class="flex items-center p-2 bg-white rounded-md cursor-pointer hover:bg-[#E6F0E8] transition"><input type="radio" id="${uniqueId}" name="q${qNum}" value="${option.value}" required class="w-4 h-4 text-darlington border-darlington focus:ring-darlington"><span class="ml-3 text-cafelatte text-sm">${option.text}</span></label>`;
                });
                questionHtml += `</div></div>`;
                form.insertAdjacentHTML('beforeend', questionHtml);
            });
            document.getElementById('assessment-modal').classList.remove('hidden');
        }

        function closeAssessmentModal() { document.getElementById('assessment-modal').classList.add('hidden'); document.getElementById('assessment-form').reset(); }
        function calculateScore(scale, formData) {
            let totalScore = 0; const assessment = assessments[scale]; const numQuestionsForScoring = scale === 'PHQ9' ? 8 : assessment.questions.length - 1;
            for (let i = 1; i <= numQuestionsForScoring; i++) {
                const key = `q${i}`; const value = parseInt(formData.get(key));
                if (isNaN(value)) { displayMessage('error', `'${i}ë²ˆ ì§ˆë¬¸'ì— ì‘ë‹µí•´ ì£¼ì„¸ìš”.`); return null; }
                if (scale === 'PSS' && assessment.reverseIndices.includes(i)) { totalScore += reverseScoreMap[value]; } else { totalScore += value; }
            }
            if (scale === 'PHQ9' && isNaN(parseInt(formData.get('q9')))) { displayMessage('error', `'9ë²ˆ ì§ˆë¬¸'ì— ì‘ë‹µí•´ ì£¼ì„¸ìš”.`); return null; }
            return totalScore;
        }

        document.getElementById('assessment-form').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            const submitButton = document.getElementById('submit-assessment');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'ì €ì¥ ì¤‘...';

            const formData = new FormData(e.target);
            const score = calculateScore(currentScale, formData); 
            
            if (score === null) {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                return;
            }
            
            const result = {}; if (currentScale === 'PHQ9') result.phq9 = score; else if (currentScale === 'GAD7') result.gad7 = score; else if (currentScale === 'PSS') result.pss = score;
            await saveAssessmentResult(result); 
            
            closeAssessmentModal();
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        });
        document.getElementById('assessment-buttons
