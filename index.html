<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Mind Mirror (MMM)</title>
    
    <!-- 1. 폰트: 고운 바탕 (빈티지 느낌) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <style>
        /* 스크롤바 스타일 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #375D49; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #F4E8C8; }

        /* 전체 배경: 이미지의 크림색 */
        body {
            background-color: #F4E8C8; 
            color: #375D49; 
            font-family: 'Gowun Batang', serif;
        }
        
        canvas { width: 100% !important; height: 100% !important; }

        /* --- 커스텀 컬러 팔레트 --- */
        
        /* 메인 텍스트 (다크 그린 #375D49) */
        .text-main { color: #375D49; }
        
        /* PHQ-9: 틸 블루 (#51A0AF) */
        .bg-teal-custom { background-color: #51A0AF; }
        .text-teal-custom { color: #51A0AF; }
        .btn-teal { background-color: #51A0AF; color: #FFFFFF; }
        .btn-teal:hover { background-color: #40808C; }

        /* GAD-7: 머스타드 옐로우 (#FFD16D) */
        .bg-mustard-custom { background-color: #FFD16D; }
        .text-mustard-custom { color: #B88A00; } /* 가독성을 위해 텍스트는 조금 더 진하게 */
        .btn-mustard { background-color: #FFD16D; color: #375D49; } 
        .btn-mustard:hover { background-color: #E5BC62; }

        /* PSS: 빈티지 레드 (#CF4638) */
        .bg-red-custom { background-color: #CF4638; }
        .text-red-custom { color: #CF4638; }
        .btn-red { background-color: #CF4638; color: #FFFFFF; }
        .btn-red:hover { background-color: #A8382D; }

        /* 몽환적인 그라데이션 테두리 효과 (요청하신 부분) */
        .dreamy-border {
            border: 5px solid transparent;
            border-radius: 1.5rem;
            /* 핑크(#EFABB4), 노랑(#FFD16D), 틸(#51A0AF) 그라데이션 */
            background-image: linear-gradient(#FDFBF7, #FDFBF7), 
                              linear-gradient(45deg, #EFABB4, #FFD16D, #51A0AF);
            background-origin: border-box;
            background-clip: content-box, border-box;
            box-shadow: 0 10px 25px -5px rgba(55, 93, 73, 0.15);
        }
    </style>
</head>


    <body class="min-h-screen flex items-center justify-center p-4 relative overflow-y-auto">

    <div id="app" class="w-full max-w-4xl dreamy-border p-6 md:p-10 relative z-10 my-8 bg-[#FDFBF7]">

        <!-- 제목 -->
        <div class="relative mb-8 pt-2 text-center"> 
            <h1 class="text-4xl font-bold text-[#375D49] mb-3" style="letter-spacing: -1px;">My Mind Mirror, MMM (음-)</h1>
            <p class="text-lg text-[#375D49]/80">1주일에 한 번은 검사를 진행하고, <br class="md:hidden">음- 그렇구나, 하고 자기 마음을 알아주세요.</p>
        </div>

        <!-- 사용자 정보 -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-center text-sm border-b-2 border-[#375D49]/20 pb-4 gap-2">
            <div id="user-info" class="text-[#375D49] flex items-center gap-3 font-bold">
                <p>ID: <span id="display-user-id" class="text-xs bg-[#F4E8C8] px-2 py-1 rounded text-[#375D49]">인증 필요</span></p>
                <p>상태: <span id="auth-status" class="text-red-custom">로드 중...</span></p>
                <button id="signout-button" class="hidden text-xs px-3 py-1 bg-[#375D49] text-white rounded hover:opacity-90 transition shadow-sm font-bold">로그아웃</button>
            </div>
        </div>

        <!-- 로그인 폼 -->
        <div id="auth-blocker" class="mb-10 p-8 bg-[#F4E8C8]/50 border-2 border-[#FFD16D] rounded-xl shadow-sm text-center">
            <h3 class="font-bold text-2xl text-[#375D49] mb-2">회원가입/로그인 필요</h3>
            <p class="text-[#375D49]/80 mb-6">개인 정보의 안전한 저장을 위해<br>이메일과 비밀번호로 회원가입, 로그인 해주세요.</p>
            
            <form id="auth-form" class="max-w-md mx-auto space-y-4">
                <input type="email" id="auth-email" placeholder="이메일 주소" required class="w-full p-3 border-2 border-[#375D49]/30 rounded-lg focus:ring-2 focus:ring-[#51A0AF] focus:outline-none bg-white text-[#375D49] placeholder-gray-400 font-bold">
                <input type="password" id="auth-password" placeholder="비밀번호 (6자 이상)" required class="w-full p-3 border-2 border-[#375D49]/30 rounded-lg focus:ring-2 focus:ring-[#51A0AF] focus:outline-none bg-white text-[#375D49] placeholder-gray-400 font-bold">
                <div class="flex gap-3 justify-center pt-2">
                    <button type="submit" id="auth-submit-button" data-mode="signin" class="flex-1 px-6 py-3 btn-teal font-bold rounded-lg shadow-md transition transform active:scale-95">로그인</button>
                    <a href="#" id="auth-mode-toggle" class="flex-1 px-6 py-3 border-2 border-[#51A0AF] text-[#51A0AF] font-bold rounded-lg hover:bg-[#51A0AF]/10 transition text-center flex items-center justify-center">회원가입 하기</a>
                </div>
            </form>
        </div>

        <!-- 측정 버튼 -->
        <div id="assessment-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
            <button data-scale="PHQ9" class="p-4 rounded-xl font-bold shadow-md transition-transform transform hover:scale-[1.02] btn-teal disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="block text-lg">PHQ-9</span><span class="text-sm opacity-90 font-normal">(우울) 측정</span>
            </button>
            <button data-scale="GAD7" class="p-4 rounded-xl font-bold shadow-md transition-transform transform hover:scale-[1.02] btn-mustard disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="block text-lg">GAD-7</span><span class="text-sm opacity-90 font-normal">(불안) 측정</span>
            </button>
            <button data-scale="PSS" class="p-4 rounded-xl font-bold shadow-md transition-transform transform hover:scale-[1.02] btn-red disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <span class="block text-lg">PSS</span><span class="text-sm opacity-90 font-normal">(스트레스) 측정</span>
            </button>
        </div>

        <!-- 메시지 박스 -->
        <div id="message-box" class="hidden px-4 py-3 rounded-xl mb-6 shadow-sm text-center" role="alert">
            <strong id="message-title" class="font-bold block mb-1"></strong> <span id="message-text"></span>
        </div>

        <!-- 차트 섹션 -->
        <div class="bg-white p-6 rounded-xl border-2 border-[#375D49]/10 shadow-inner">
            <h2 class="text-2xl font-bold text-[#375D49] mb-6 text-center">나의 MMM (음-) 프로파일</h2>
            <div id="chart-caption" class="text-center text-sm text-gray-500 mb-8">데이터가 없습니다. 측정을 시작해 주세요!</div>

            <div class="space-y-12">
                <div class="p-5 rounded-xl bg-white border-l-4 border-[#51A0AF] shadow-sm">
                    <h3 class="font-bold text-lg text-teal-custom mb-3">우울의 움직임 (PHQ-9)</h3>
                    <div class="relative h-56 md:h-72"><canvas id="phqChart"></canvas></div>
                </div>
                <div class="p-5 rounded-xl bg-white border-l-4 border-[#FFD16D] shadow-sm">
                    <h3 class="font-bold text-lg text-mustard-custom mb-3">불안의 움직임 (GAD-7)</h3>
                    <div class="relative h-56 md:h-72"><canvas id="gadChart"></canvas></div>
                </div>
                <div class="p-5 rounded-xl bg-white border-l-4 border-[#CF4638] shadow-sm">
                    <h3 class="font-bold text-lg text-red-custom mb-3">내가 느끼는 스트레스 (PSS)</h3>
                    <div class="relative h-56 md:h-72"><canvas id="pssChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- 요약 섹션 -->
        <div class="mt-10">
            <h2 class="text-2xl font-bold text-[#375D49] mb-6 text-center">최근 측정 요약</h2>
            <div id="latest-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-6 rounded-xl shadow-md border-t-4 border-[#51A0AF] bg-[#F0FDFA]">
                    <p class="font-bold text-lg text-teal-custom mb-2">PHQ-9</p>
                    <div class="flex items-end gap-2">
                        <p class="text-4xl font-extrabold text-[#375D49]" id="latest-phq">--</p>
                        <p class="text-sm text-gray-500 mb-1">/ 27점</p>
                    </div>
                </div>
                <div class="p-6 rounded-xl shadow-md border-t-4 border-[#FFD16D] bg-[#FFFBEB]">
                    <p class="font-bold text-lg text-mustard-custom mb-2">GAD-7</p>
                    <div class="flex items-end gap-2">
                        <p class="text-4xl font-extrabold text-[#375D49]" id="latest-gad">--</p>
                        <p class="text-sm text-gray-500 mb-1">/ 21점</p>
                    </div>
                </div>
                <div class="p-6 rounded-xl shadow-md border-t-4 border-[#CF4638] bg-[#FFF1F2]">
                    <p class="font-bold text-lg text-red-custom mb-2">PSS</p>
                    <div class="flex items-end gap-2">
                        <p class="text-4xl font-extrabold text-[#375D49]" id="latest-pss">--</p>
                        <p class="text-sm text-gray-500 mb-1">/ 40점</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달 -->
    <div id="assessment-modal" class="hidden fixed inset-0 bg-[#375D49]/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 font-vintage">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-300 border-2 border-[#375D49]/10">
            <div id="modal-header" class="p-6 text-white text-xl font-bold"><span id="scale-title"></span> 측정</div>
            <div class="p-6 custom-scrollbar max-h-[70vh] overflow-y-auto"><form id="assessment-form"></form></div>
            <div class="p-4 border-t border-gray-100 flex justify-end space-x-3 bg-[#F4E8C8]">
                <button id="cancel-assessment" type="button" class="px-4 py-2 bg-white border-2 border-[#375D49]/20 text-[#375D49] rounded-lg hover:bg-gray-50 font-bold">취소</button>
                <button id="submit-assessment" type="submit" form="assessment-form" class="px-6 py-2 text-white rounded-lg font-bold shadow-lg">결과 저장</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'my-mind-mirror-mmm-prod'; 
        const firebaseConfig = {
            apiKey: "AIzaSyDJ5lpzMYtQP_TrfqXQDF9QTmAVYNU84kE",
            authDomain: "mmm-project-13fb3.firebaseapp.com",
            projectId: "mmm-project-13fb3",
            storageBucket: "mmm-project-13fb3.firebasestorage.app",
            messagingSenderId: "845948284004",
            appId: "1:845948284004:web:aec6d670eb1e656a5a0371",
            measurementId: "G-3TJ21YRM59"
        };

        let app, db, auth, userId = null;
        let phqChartInstance = null, gadChartInstance = null, pssChartInstance = null;
        
        // Vivid Palette Colors
        const CHART_COLORS = {
            PHQ9: { color: '#51A0AF', bgColor: 'transparent' }, 
            GAD7: { color: '#FFD16D', bgColor: 'transparent' }, 
            PSS: { color: '#CF4638', bgColor: 'transparent' } 
        };

        const CHART_CONFIGS = {
            PHQ9: { id: 'phqChart', label: 'PHQ-9 (우울)', maxScore: 27, prop: 'phq9', instance: 'phqChartInstance', ...CHART_COLORS.PHQ9 },
            GAD7: { id: 'gadChart', label: 'GAD-7 (불안)', maxScore: 21, prop: 'gad7', instance: 'gadChartInstance', ...CHART_COLORS.GAD7 },
            PSS: { id: 'pssChart', label: 'PSS (스트레스)', maxScore: 40, prop: 'pss', instance: 'pssChartInstance', ...CHART_COLORS.PSS }
        };

        const responseOptionsPHQGAD = [{value:0,text:"전혀 없음"},{value:1,text:"몇 일"},{value:2,text:"일주일에 반 이상"},{value:3,text:"거의 매일"}];
        const responseOptionsPSS = [{value:0,text:"전혀 없다"},{value:1,text:"거의 없다"},{value:2,text:"때때로 있다"},{value:3,text:"자주 있다"},{value:4,text:"매우 자주 있다"}];
        const reverseScoreMap = {0:4,1:3,2:2,3:1,4:0};
        
        const assessments = {
            PHQ9: { title: "PHQ-9 (우울증 선별 도구)", colorClass: 'btn-teal', options: responseOptionsPHQGAD, questions: ["지난 2주 동안, 다음 문제들로 인해 얼마나 자주 불편을 겪으셨습니까?", "1. 일에 흥미나 즐거움이 거의 없었다.", "2. 기분이 가라앉거나, 우울하거나, 희망이 없다고 느꼈다.", "3. 잠들거나 계속 잠을 자는 데 어려움이 있거나, 너무 많이 잤다.", "4. 피곤하거나 기력이 거의 없었다.", "5. 식욕이 없거나 과식했다.", "6. 자신을 실패자라고 느끼거나, 자신이나 가족을 실망시켰다고 느꼈다.", "7. 신문 읽기나 TV 시청처럼 평소보다 느리게 움직이거나 말을 했고, 다른 사람들이 알아챌 정도였다. 또는 이와 반대로 너무 안절부절못해서 평소보다 많이 움직였다.", "8. 집중하기가 어렵다(예: 신문 읽기, TV 시청 시).", "9. 지난 2주 동안 이 문제들로 인해 직장/학업, 가정 생활, 또는 다른 사람들과의 관계에서 어려움이 있었다면 얼마나 심각했습니까?"].slice(0, 10) },
            GAD7: { title: "GAD-7 (범불안장애 선별 도구)", colorClass: 'btn-mustard', options: responseOptionsPHQGAD, questions: ["지난 2주 동안, 다음 문제들로 인해 얼마나 자주 불편을 겪으셨습니까?", "1. 안절부절못하거나 평온하게 있을 수 없었다.", "2. 쉽게 짜증을 내거나 신경이 곤두서 있었다.", "3. 무엇인가 걱정하는 것을 멈출 수 없거나 조절할 수 없었다.", "4. 지나치게 걱정했다.", "5. 여러 가지 일에 대해 너무 걱정했다.", "6. 불안 때문에 휴식을 취하기 어려웠다.", "7. 너무 걱정되어서 잠들기가 어려웠다."] },
            PSS: { title: "PSS-10 (지각된 스트레스 척도)", colorClass: 'btn-red', options: responseOptionsPSS, questions: ["지난 한 달 동안, 다음 각 질문의 상황이 얼마나 자주 있었는지 응답해 주십시오. (10문항)", "1. 예기치 않은 일들 때문에 당황했던 적이 얼마나 자주 있었습니까?", "2. 생활의 중요한 일들을 통제할 수 없다고 느꼈던 적이 얼마나 자주 있었습니까?", "3. 신경이 예민해지고 스트레스를 받았다고 느꼈던 적이 얼마나 자주 있었습니까?", "4. 생활 속에서 일어나는 일들을 처리하는 데 효과적으로 대처한다고 느꼈던 적이 얼마나 자주 있었습니까?", "5. 당신에게 중요한 일들을 완벽하게 처리할 수 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "6. 당신이 통제할 수 없었던 일들 때문에 화가 났던 적이 얼마나 자주 있었습니까?", "7. 사소한 일들에 대해 성공적으로 대처한다고 느꼈던 적이 얼마나 자주 있었습니까?", "8. 쌓여 있는 일들을 잘 처리하고 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "9. 당신이 감당할 수 없을 정도로 많은 일들이 쌓여 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "10. 당신의 개인적인 일들이 계획대로 진행되고 있다고 느꼈던 적이 얼마나 자주 있었습니까?"], reverseIndices: [4, 5, 7, 8, 10] }
        };

        function toggleAppFeatures(enable) {
            const buttons = document.querySelectorAll('#assessment-buttons button');
            buttons.forEach(btn => btn.disabled = !enable);
            const blocker = document.getElementById('auth-blocker');
            const signoutButton = document.getElementById('signout-button');
            if (enable) { blocker.classList.add('hidden'); signoutButton.classList.remove('hidden'); } 
            else { blocker.classList.remove('hidden'); signoutButton.classList.add('hidden'); }
        }
        
        function displayMessage(type, message) {
            const box = document.getElementById('message-box');
            const title = document.getElementById('message-title');
            const text = document.getElementById('message-text');
            box.className = 'px-4 py-3 rounded-xl mb-6 shadow-sm text-center'; title.className = 'font-bold block mb-1'; text.className = 'block sm:inline';
            if (type === 'error') { box.classList.add('bg-[#CF4638]/10', 'border-2', 'border-[#CF4638]', 'text-[#CF4638]'); title.textContent = '오류 발생!'; } 
            else if (type === 'success') { box.classList.add('bg-[#51A0AF]/20', 'border-2', 'border-[#51A0AF]', 'text-[#375D49]'); title.textContent = '알림'; } 
            else { box.classList.add('bg-[#FFD16D]/20', 'border-2', 'border-[#FFD16D]', 'text-[#375D49]'); title.textContent = '정보'; }
            text.textContent = message; box.classList.remove('hidden'); setTimeout(() => box.classList.add('hidden'), 8000);
        }

        async function signInUser(email, password) {
            showLoading(true);
            try { await signInWithEmailAndPassword(auth, email, password); displayMessage('success', "로그인 성공!"); } 
            catch (error) { console.error(error); displayMessage('error', `로그인 실패: ${error.message}`); } 
            finally { showLoading(false); }
        }

        async function signUpUser(email, password) {
            showLoading(true);
            try { await createUserWithEmailAndPassword(auth, email, password); displayMessage('success', "회원가입 및 로그인 완료!"); } 
            catch (error) { console.error(error); displayMessage('error', `회원가입 실패: ${error.message}`); } 
            finally { showLoading(false); }
        }
        
        function handleSignOut() {
            showLoading(true);
            signOut(auth).then(() => { displayMessage('success', "로그아웃되었습니다."); }).catch((error) => { displayMessage('error', "로그아웃 오류"); }).finally(() => { showLoading(false); });
        }
        
        async function initFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.getElementById('auth-status').textContent = '설정 오류';
                displayMessage('error', "Firebase 설정을 확인해주세요."); toggleAppFeatures(false); return;
            }
            try {
                setLogLevel('error'); app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                document.getElementById('auth-status').textContent = '대기 중...';
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; document.getElementById('auth-status').textContent = `인증 완료`; document.getElementById('display-user-id').textContent = userId; toggleAppFeatures(true); setupRealtimeListener(); } 
                    else { userId = null; document.getElementById('auth-status').textContent = '로그인 필요'; document.getElementById('display-user-id').textContent = '인증 필요'; toggleAppFeatures(false); updateCharts([]); updateSummary([]); }
                });
            } catch (error) { console.error(error); displayMessage('error', "Firebase 초기화 실패"); toggleAppFeatures(false); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('auth-form');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authModeToggle = document.getElementById('auth-mode-toggle');
            if(authForm) {
                authForm.addEventListener('submit', function(e) { e.preventDefault(); const email = document.getElementById('auth-email').value; const password = document.getElementById('auth-password').value; const mode = authSubmitButton.dataset.mode; if (mode === 'signin') { signInUser(email, password); } else { signUpUser(email, password); } });
                authModeToggle.addEventListener('click', function(e) { e.preventDefault(); if (authSubmitButton.dataset.mode === 'signin') { authSubmitButton.dataset.mode = 'signup'; authSubmitButton.textContent = '회원가입'; authModeToggle.textContent = '로그인 화면으로 돌아가기'; } else { authSubmitButton.dataset.mode = 'signin'; authSubmitButton.textContent = '로그인'; authModeToggle.textContent = '회원가입 하기'; } });
            }
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            initFirebase();
        });
        
        function getCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/stress_trackers`);
        }

        function setupRealtimeListener() {
            const colRef = getCollectionRef(); if (!colRef) return;
            onSnapshot(colRef, (snapshot) => {
                const results = []; snapshot.forEach((doc) => { results.push({ id: doc.id, ...doc.data() }); });
                
                // Smart Deduplication
                results.sort((a, b) => (a.timestamp ? a.timestamp.toDate() : 0) - (b.timestamp ? b.timestamp.toDate() : 0));
                const filteredResults = [];
                let lastTime = 0;
                results.forEach(item => {
                    const itemTime = item.timestamp ? item.timestamp.toDate().getTime() : 0;
                    if (itemTime - lastTime > 60000) { 
                        filteredResults.push(item);
                        lastTime = itemTime;
                    }
                });

                updateCharts(filteredResults); updateSummary(filteredResults);
            }, (error) => { console.error(error); displayMessage('error', "데이터 불러오기 오류"); });
        }
        
        async function saveAssessmentResult(result) {
            const colRef = getCollectionRef(); if (!colRef) { displayMessage('error', "로그인이 필요합니다."); return; }
            showLoading(true);
            try { await addDoc(colRef, { ...result, timestamp: serverTimestamp() }); displayMessage('success', "저장 완료!"); } 
            catch (error) { console.error(error); displayMessage('error', "저장 실패"); } 
            finally { showLoading(false); }
        }
        
        function createOrUpdateChart(chartId, dataLabels, scoreData, config) {
            const ctx = document.getElementById(chartId).getContext('2d');
            let instance;
            if (config.instance === 'phqChartInstance') instance = phqChartInstance;
            else if (config.instance === 'gadChartInstance') instance = gadChartInstance;
            else if (config.instance === 'pssChartInstance') instance = pssChartInstance;

            if (instance) { 
                instance.data.labels = dataLabels; 
                instance.data.datasets[0].data = scoreData;
                // 데이터 포인트가 1개 초과일 때만 선 표시
                instance.data.datasets[0].showLine = scoreData.filter(v => v !== null).length > 1;
                instance.update(); 
                return instance; 
            }

            const shouldShowLine = scoreData.filter(v => v !== null).length > 1;

            const newInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataLabels,
                    datasets: [{
                        label: config.label, 
                        data: scoreData, 
                        borderColor: config.color, 
                        backgroundColor: 'transparent',
                        tension: 0.4, 
                        fill: false, 
                        pointBackgroundColor: config.color, 
                        pointBorderColor: '#fff', 
                        pointBorderWidth: 3, 
                        pointRadius: 6, 
                        pointHoverRadius: 8,
                        showLine: shouldShowLine 
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: true } },
                    elements: { line: { tension: 0.4 }, point: { pointStyle: 'circle' } },
                    scales: { y: { beginAtZero: true, max: config.maxScore, title: { display: true, text: '점수' }, ticks: { precision: 0 } }, x: { type: 'category', title: { display: true, text: '측정 시점' }, ticks: { autoSkip: true, maxTicksLimit: 7 } } }
                }
            });
            
            if (config.instance === 'phqChartInstance') phqChartInstance = newInstance;
            else if (config.instance === 'gadChartInstance') gadChartInstance = newInstance;
            else if (config.instance === 'pssChartInstance') pssChartInstance = newInstance;
            return newInstance;
        }

        function updateCharts(data) {
            if (data.length === 0) return;

            // Independent Data Filtering for each chart
            const phqData = data.filter(d => d.phq9 !== undefined);
            const phqLabels = phqData.map(item => formatTimestamp(item.timestamp));
            const phqScores = phqData.map(item => item.phq9);
            
            const gadData = data.filter(d => d.gad7 !== undefined);
            const gadLabels = gadData.map(item => formatTimestamp(item.timestamp));
            const gadScores = gadData.map(item => item.gad7);

            const pssData = data.filter(d => d.pss !== undefined);
            const pssLabels = pssData.map(item => formatTimestamp(item.timestamp));
            const pssScores = pssData.map(item => item.pss);

            createOrUpdateChart(CHART_CONFIGS.PHQ9.id, phqLabels, phqScores, CHART_CONFIGS.PHQ9);
            createOrUpdateChart(CHART_CONFIGS.GAD7.id, gadLabels, gadScores, CHART_CONFIGS.GAD7);
            createOrUpdateChart(CHART_CONFIGS.PSS.id, pssLabels, pssScores, CHART_CONFIGS.PSS);

            document.getElementById('chart-caption').textContent = `총 ${data.length}건의 측정 기록이 있습니다.`;
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            const year = String(date.getFullYear()).slice(-2);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        function updateSummary(data) {
            const latestScores = { phq9: '--', gad7: '--', pss: '--' };
            for (let i = data.length - 1; i >= 0; i--) {
                const item = data[i];
                if (latestScores.phq9 === '--' && item.phq9 !== undefined) latestScores.phq9 = item.phq9;
                if (latestScores.gad7 === '--' && item.gad7 !== undefined) latestScores.gad7 = item.gad7;
                if (latestScores.pss === '--' && item.pss !== undefined) latestScores.pss = item.pss;
                if (latestScores.phq9 !== '--' && latestScores.gad7 !== '--' && latestScores.pss !== '--') break;
            }
            document.getElementById('latest-phq').textContent = latestScores.phq9;
            document.getElementById('latest-gad').textContent = latestScores.gad7;
            document.getElementById('latest-pss').textContent = latestScores.pss;
        }

        let currentScale = '';
        function openAssessmentModal(scale) {
            if (!userId) { displayMessage('error', "로그인이 필요합니다."); return; }
            currentScale = scale; const assessment = assessments[scale];
            document.getElementById('scale-title').textContent = assessment.title.split(' ')[0];
            const header = document.getElementById('modal-header');
            ['bg-teal-custom', 'bg-mustard-custom', 'bg-red-custom'].forEach(c => header.classList.remove(c));
            header.classList.add(assessment.colorClass.split(' ')[0]);
            const submitButton = document.getElementById('submit-assessment');
            ['btn-teal', 'btn-mustard', 'btn-red'].forEach(c => submitButton.classList.remove(c));
            submitButton.classList.add(assessment.colorClass);

            const form = document.getElementById('assessment-form'); form.innerHTML = '';
            let introText = `<p class="text-main mb-4 font-bold">${assessment.questions[0]}</p>`; form.insertAdjacentHTML('beforeend', introText);
            const questionsToRender = scale === 'PHQ9' ? assessment.questions.slice(1, 10) : assessment.questions.slice(1);
            questionsToRender.forEach((questionText, index) => {
                const qNum = index + 1;
                let questionHtml = `<div class="mb-5 p-4 border border-[#375D49]/30 rounded-lg shadow-sm bg-[#F4E8C8]/20"><p class="font-semibold text-main mb-3">${questionText}</p><div class="space-y-2">`;
                assessment.options.forEach(option => {
                    const uniqueId = `${scale}-q${qNum}-v${option.value}`;
                    questionHtml += `<label for="${uniqueId}" class="flex items-center p-2 bg-white rounded-md cursor-pointer hover:bg-[#F4E8C8] transition border border-[#375D49]/10"><input type="radio" id="${uniqueId}" name="q${qNum}" value="${option.value}" required class="w-4 h-4 text-main border-main focus:ring-main"><span class="ml-3 text-main text-sm">${option.text}</span></label>`;
                });
                questionHtml += `</div></div>`;
                form.insertAdjacentHTML('beforeend', questionHtml);
            });
            document.getElementById('assessment-modal').classList.remove('hidden');
        }

        function closeAssessmentModal() { document.getElementById('assessment-modal').classList.add('hidden'); document.getElementById('assessment-form').reset(); }
        function calculateScore(scale, formData) {
            let totalScore = 0; const assessment = assessments[scale]; const numQuestionsForScoring = scale === 'PHQ9' ? 8 : assessment.questions.length - 1;
            for (let i = 1; i <= numQuestionsForScoring; i++) {
                const key = `q${i}`; const value = parseInt(formData.get(key));
                if (isNaN(value)) { displayMessage('error', `'${i}번 질문'에 응답해 주세요.`); return null; }
                if (scale === 'PSS' && assessment.reverseIndices.includes(i)) { totalScore += reverseScoreMap[value]; } else { totalScore += value; }
            }
            if (scale === 'PHQ9' && isNaN(parseInt(formData.get('q9')))) { displayMessage('error', `'9번 질문'에 응답해 주세요.`); return null; }
            return totalScore;
        }

        document.getElementById('assessment-form').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            const submitButton = document.getElementById('submit-assessment');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = '저장 중...';

            const formData = new FormData(e.target);
            const score = calculateScore(currentScale, formData); 
            
            if (score === null) {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                return;
            }
            
            const result = {}; if (currentScale === 'PHQ9') result.phq9 = score; else if (currentScale === 'GAD7') result.gad7 = score; else if (currentScale === 'PSS') result.pss = score;
            await saveAssessmentResult(result); 
            
            closeAssessmentModal();
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        });
        document.getElementById('assessment-buttons').addEventListener('click', (e) => { const button = e.target.closest('button[data-scale]'); if (button) openAssessmentModal(button.dataset.scale); });
        document.getElementById('cancel-assessment').addEventListener('click', closeAssessmentModal);
        function showLoading(isLoading) { const loadingDiv = document.getElementById('loading-indicator'); if (isLoading) { loadingDiv.classList.remove('hidden'); } else { loadingDiv.classList.add('hidden'); } }
    </script>
</body>
</html>

