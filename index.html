<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Mind Mirror (MMM)</title>
    
    <!-- 폰트: 고운 바탕 (빈티지 느낌) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <style>
        /* 스크롤바 스타일 */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #375D49; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #F4E8C8; }

        /* 전체 배경: 이미지의 크림색, 텍스트: 다크 그린 */
        body {
            background-color: #F4E8C8; 
            color: #375D49; 
            font-family: 'Gowun Batang', serif;
        }
        
        canvas { width: 100% !important; height: 100% !important; }

        /* --- 커스텀 컬러 팔레트 (이미지 기반) --- */
        
        /* 메인 텍스트/테두리 (다크 그린 #375D49) */
        .text-main { color: #375D49; }
        .border-main { border-color: #375D49; }
        .bg-main { background-color: #375D49; }
        
        /* PHQ-9: 틸 블루 (#51A0AF) */
        .bg-teal-custom { background-color: #51A0AF; }
        .text-teal-custom { color: #51A0AF; }
        .border-teal-custom { border-color: #51A0AF; }
        .btn-teal { background-color: #51A0AF; color: #FFFFFF; }
        .btn-teal:hover { background-color: #40808C; }

        /* GAD-7: 머스타드 옐로우 (#FFD16D) */
        .bg-mustard-custom { background-color: #FFD16D; }
        .text-mustard-custom { color: #E0B050; } 
        .border-mustard-custom { border-color: #FFD16D; }
        .btn-mustard { background-color: #FFD16D; color: #375D49; } 
        .btn-mustard:hover { background-color: #E5BC62; }

        /* PSS: 빈티지 레드 (#CF4638) - 이미지의 붉은 톤 */
        .bg-red-custom { background-color: #CF4638; }
        .text-red-custom { color: #CF4638; }
        .border-red-custom { border-color: #CF4638; }
        .btn-red { background-color: #CF4638; color: #FFFFFF; }
        .btn-red:hover { background-color: #A8382D; }
        
        /* 테두리 효과 */
        .dreamy-border {
            border: 4px solid #375D49;
            border-radius: 1.5rem;
            box-shadow: 8px 8px 0px rgba(55, 93, 73, 0.2);
        }
        
        /* 차트 카드 배경색 */
        .phq-card-color { background-color: rgba(81, 160, 175, 0.1); }
        .gad-card-color { background-color: rgba(255, 209, 109, 0.2); }
        .pss-card-color { background-color: rgba(207, 70, 56, 0.1); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative overflow-y-auto">

    <!-- 메인 컨테이너 -->
    <div id="app" class="w-full max-w-4xl dreamy-border p-6 md:p-10 relative z-10 my-8 bg-[#FDFBF7]">

        <!-- 제목 -->
        <div class="relative mb-8 pt-2 text-center"> 
            <h1 class="text-4xl font-bold text-[#375D49] mb-3" style="letter-spacing: -1px;">My Mind Mirror, MMM (음-)</h1>
            <p class="text-lg text-[#375D49]/80">1주일에 한 번은 검사를 진행하고, <br class="md:hidden">음- 그렇구나, 하고 자기 마음을 알아주세요.</p>
        </div>

        <!-- 사용자 정보 -->
        <div class="mb-8 flex flex-col md:flex-row justify-between items-center text-sm border-b-2 border-[#375D49]/20 pb-4 gap-2">
            <div id="user-info" class="text-[#375D49] flex items-center gap-3 font-bold">
                <p>ID: <span id="display-user-id" class="font-mono text-xs bg-[#F4E8C8] px-2 py-1 rounded text-[#375D49]">인증 필요</span></p>
                <p>상태: <span id="auth-status" class="text-red-custom">로드 중...</span></p>
                <button id="signout-button" class="hidden text-xs px-3 py-1 bg-[#375D49] text-white rounded hover:opacity-90 transition shadow-sm font-bold">로그아웃</button>
            </div>
            <div id="loading-indicator" class="hidden flex items-center gap-2 text-teal-custom font-bold">
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>데이터 처리 중...</span>
            </div>
        </div>

        <!-- 로그인 폼 -->
        <div id="auth-blocker" class="mb-10 p-8 bg-[#F4E8C8]/30 border-2 border-[#FFD16D] rounded-xl shadow-sm text-center">
            <h3 class="font-bold text-2xl text-[#375D49] mb-2">회원가입/로그인 필요</h3>
            <p class="text-[#375D49]/80 mb-6">개인 정보의 안전한 저장을 위해<br>이메일과 비밀번호로 회원가입, 로그인 해주세요.</p>
            
            <form id="auth-form" class="max-w-md mx-auto space-y-4">
                <input type="email" id="auth-email" placeholder="이메일 주소" required class="w-full p-3 border-2 border-[#375D49]/30 rounded-lg focus:ring-2 focus:ring-[#51A0AF] focus:outline-none bg-white text-[#375D49] placeholder-main/40 font-bold">
                <input type="password" id="auth-password" placeholder="비밀번호 (6자 이상)" required class="w-full p-3 border-2 border-[#375D49]/30 rounded-lg focus:ring-2 focus:ring-[#51A0AF] focus:outline-none bg-white text-[#375D49] placeholder-main/40 font-bold">
                <div class="flex gap-3 justify-center pt-2">
                    <button type="submit" id="auth-submit-button" data-mode="signin" class="px-6 py-2 btn-teal font-bold rounded-lg shadow-md transition transform active:scale-95 flex-1">로그인</button>
                    <a href="#" id="auth-mode-toggle" class="px-6 py-2 border-2 border-[#51A0AF] text-[#51A0AF] font-bold rounded-lg hover:bg-[#51A0AF]/10 transition text-center flex items-center justify-center flex-1">회원가입 하기</a>
                </div>
            </form>
        </div>

        <!-- 측정 버튼 영역 (비비드 컬러, 검정 테두리 적용) -->
        <div id="assessment-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10">
            <button data-scale="PHQ9" class="p-4 rounded-xl font-bold btn-teal btn-vivid" disabled>
                <span class="block text-lg">PHQ-9</span><span class="text-sm opacity-90 font-normal">(우울) 측정</span>
            </button>
            <button data-scale="GAD7" class="p-4 rounded-xl font-bold btn-mustard btn-vivid" disabled>
                <span class="block text-lg">GAD-7</span><span class="text-sm opacity-90 font-normal">(불안) 측정</span>
            </button>
            <button data-scale="PSS" class="p-4 rounded-xl font-bold btn-red btn-vivid" disabled>
                <span class="block text-lg">PSS</span><span class="text-sm opacity-90 font-normal">(스트레스) 측정</span>
            </button>
        </div>

        <!-- 메시지 박스 -->
        <div id="message-box" class="hidden px-4 py-3 rounded-xl mb-6 shadow-sm text-center" role="alert">
            <strong id="message-title" class="font-bold block mb-1"></strong> 
            <span id="message-text"></span>
        </div>

        <!-- 차트 섹션 -->
        <div class="bg-white p-6 rounded-xl border-2 border-[#375D49]/10 shadow-inner">
            <h2 class="text-2xl font-bold text-[#375D49] mb-6 text-center">나의 MMM (음-) 프로파일</h2>
            <div id="chart-caption" class="text-center text-sm text-gray-500 mb-8">데이터가 없습니다. 측정을 시작해 주세요!</div>

            <div class="space-y-12">
                <!-- PHQ-9 Chart -->
                <div class="p-5 rounded-xl bg-white border-l-4 border-[#51A0AF] shadow-sm">
                    <h3 class="font-bold text-lg text-teal-custom mb-3 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-[#51A0AF]"></span> 우울의 움직임 (PHQ-9)
                    </h3>
                    <div class="relative h-56 md:h-72"><canvas id="phqChart"></canvas></div>
                </div>
                <!-- GAD-7 Chart -->
                <div class="p-5 rounded-xl bg-white border-l-4 border-[#FFD16D] shadow-sm">
                    <h3 class="font-bold text-lg text-mustard-custom mb-3 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-[#FFD16D]"></span> 불안의 움직임 (GAD-7)
                    </h3>
                    <div class="relative h-56 md:h-72"><canvas id="gadChart"></canvas></div>
                </div>
                <!-- PSS Chart -->
                <div class="p-5 rounded-xl bg-white border-l-4 border-[#CF4638] shadow-sm">
                    <h3 class="font-bold text-lg text-red-custom mb-3 flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-[#CF4638]"></span> 내가 느끼는 스트레스 (PSS)
                    </h3>
                    <div class="relative h-56 md:h-72"><canvas id="pssChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- 요약 섹션 -->
        <div class="mt-10">
            <h2 class="text-2xl font-bold text-[#375D49] mb-6 text-center">최근 측정 요약</h2>
            <div id="latest-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="p-6 rounded-xl shadow-md border-t-4 border-[#51A0AF] bg-[#F0FDFA]">
                    <p class="font-bold text-lg text-teal-custom mb-2">PHQ-9</p>
                    <div class="flex items-end gap-2">
                        <p class="text-4xl font-extrabold text-[#375D49]" id="latest-phq">--</p>
                        <p class="text-sm text-gray-500 mb-1">/ 27점</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">우울 점수</p>
                </div>
                <div class="p-6 rounded-xl shadow-md border-t-4 border-[#FFD16D] bg-[#FFFBEB]">
                    <p class="font-bold text-lg text-mustard-custom mb-2">GAD-7</p>
                    <div class="flex items-end gap-2">
                        <p class="text-4xl font-extrabold text-[#375D49]" id="latest-gad">--</p>
                        <p class="text-sm text-gray-500 mb-1">/ 21점</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">불안 점수</p>
                </div>
                <div class="p-6 rounded-xl shadow-md border-t-4 border-[#CF4638] bg-[#FFF1F2]">
                    <p class="font-bold text-lg text-red-custom mb-2">PSS</p>
                    <div class="flex items-end gap-2">
                        <p class="text-4xl font-extrabold text-[#375D49]" id="latest-pss">--</p>
                        <p class="text-sm text-gray-500 mb-1">/ 40점</p>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">스트레스 점수</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="assessment-modal" class="hidden fixed inset-0 bg-[#375D49]/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-300 border-2 border-[#375D49]/10">
            <div id="modal-header" class="p-6 text-white text-xl font-bold"><span id="scale-title"></span> 측정</div>
            <div class="p-6 custom-scrollbar max-h-[70vh] overflow-y-auto"><form id="assessment-form"></form></div>
            <div class="p-4 border-t border-gray-100 flex justify-end space-x-3 bg-[#F4E8C8]">
                <button id="cancel-assessment" type="button" class="px-4 py-2 bg-white border-2 border-[#375D49]/20 text-[#375D49] rounded-lg hover:bg-gray-50 font-bold">취소</button>
                <button id="submit-assessment" type="submit" form="assessment-form" class="px-6 py-2 text-white rounded-lg font-bold shadow-lg">결과 저장</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'my-mind-mirror-mmm-prod'; 
        const firebaseConfig = {
            apiKey: "AIzaSyDJ5lpzMYtQP_TrfqXQDF9QTmAVYNU84kE",
            authDomain: "mmm-project-13fb3.firebaseapp.com",
            projectId: "mmm-project-13fb3",
            storageBucket: "mmm-project-13fb3.firebasestorage.app",
            messagingSenderId: "845948284004",
            appId: "1:845948284004:web:aec6d670eb1e656a5a0371",
            measurementId: "G-3TJ21YRM59"
        };

        let app, db, auth, userId = null;
        let phqChartInstance = null, gadChartInstance = null, pssChartInstance = null;
        let scaleData = null;
        
        // Colors
        const CHART_COLORS = {
            PHQ9: { color: '#51A0AF', bgColor: 'transparent' },
            GAD7: { color: '#FFD16D', bgColor: 'transparent' },
            PSS: { color: '#CF4638', bgColor: 'transparent' }
        };

        const CHART_CONFIGS = {
            PHQ9: { id: 'phqChart', label: 'PHQ-9 (우울)', maxScore: 27, prop: 'phq9', instance: 'phqChartInstance', ...CHART_COLORS.PHQ9 },
            GAD7: { id: 'gadChart', label: 'GAD-7 (불안)', maxScore: 21, prop: 'gad7', instance: 'gadChartInstance', ...CHART_COLORS.GAD7 },
            PSS: { id: 'pssChart', label: 'PSS (스트레스)', maxScore: 40, prop: 'pss', instance: 'pssChartInstance', ...CHART_COLORS.PSS }
        };

        const responseOptionsPHQGAD = [{value:0,text:"전혀 없음"},{value:1,text:"몇 일"},{value:2,text:"일주일에 반 이상"},{value:3,text:"거의 매일"}];
        const responseOptionsPSS = [{value:0,text:"전혀 없다"},{value:1,text:"거의 없다"},{value:2,text:"때때로 있다"},{value:3,text:"자주 있다"},{value:4,text:"매우 자주 있다"}];
        const reverseScoreMap = {0:4,1:3,2:2,3:1,4:0};
        
        const assessments = {
            PHQ9: { title: "PHQ-9 (우울증 선별 도구)", colorClass: 'btn-teal', headerClass: 'bg-[#51A0AF]', options: responseOptionsPHQGAD, questions: ["지난 2주 동안, 다음 문제들로 인해 얼마나 자주 불편을 겪으셨습니까?", "1. 일에 흥미나 즐거움이 거의 없었다.", "2. 기분이 가라앉거나, 우울하거나, 희망이 없다고 느꼈다.", "3. 잠들거나 계속 잠을 자는 데 어려움이 있거나, 너무 많이 잤다.", "4. 피곤하거나 기력이 거의 없었다.", "5. 식욕이 없거나 과식했다.", "6. 자신을 실패자라고 느끼거나, 자신이나 가족을 실망시켰다고 느꼈다.", "7. 신문 읽기나 TV 시청처럼 평소보다 느리게 움직이거나 말을 했고, 다른 사람들이 알아챌 정도였다. 또는 이와 반대로 너무 안절부절못해서 평소보다 많이 움직였다.", "8. 집중하기가 어렵다(예: 신문 읽기, TV 시청 시).", "9. 지난 2주 동안 이 문제들로 인해 직장/학업, 가정 생활, 또는 다른 사람들과의 관계에서 어려움이 있었다면 얼마나 심각했습니까?"].slice(0, 10) },
            GAD7: { title: "GAD-7 (범불안장애 선별 도구)", colorClass: 'btn-mustard', headerClass: 'bg-[#FFD16D]', options: responseOptionsPHQGAD, questions: ["지난 2주 동안, 다음 문제들로 인해 얼마나 자주 불편을 겪으셨습니까?", "1. 안절부절못하거나 평온하게 있을 수 없었다.", "2. 쉽게 짜증을 내거나 신경이 곤두서 있었다.", "3. 무엇인가 걱정하는 것을 멈출 수 없거나 조절할 수 없었다.", "4. 지나치게 걱정했다.", "5. 여러 가지 일에 대해 너무 걱정했다.", "6. 불안 때문에 휴식을 취하기 어려웠다.", "7. 너무 걱정되어서 잠들기가 어려웠다."] },
            PSS: { title: "PSS-10 (지각된 스트레스 척도)", colorClass: 'btn-red', headerClass: 'bg-[#CF4638]', options: responseOptionsPSS, questions: ["지난 한 달 동안, 다음 각 질문의 상황이 얼마나 자주 있었는지 응답해 주십시오. (10문항)", "1. 예기치 않은 일들 때문에 당황했던 적이 얼마나 자주 있었습니까?", "2. 생활의 중요한 일들을 통제할 수 없다고 느꼈던 적이 얼마나 자주 있었습니까?", "3. 신경이 예민해지고 스트레스를 받았다고 느꼈던 적이 얼마나 자주 있었습니까?", "4. 생활 속에서 일어나는 일들을 처리하는 데 효과적으로 대처한다고 느꼈던 적이 얼마나 자주 있었습니까?", "5. 당신에게 중요한 일들을 완벽하게 처리할 수 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "6. 당신이 통제할 수 없었던 일들 때문에 화가 났던 적이 얼마나 자주 있었습니까?", "7. 사소한 일들에 대해 성공적으로 대처한다고 느꼈던 적이 얼마나 자주 있었습니까?", "8. 쌓여 있는 일들을 잘 처리하고 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "9. 당신이 감당할 수 없을 정도로 많은 일들이 쌓여 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "10. 당신의 개인적인 일들이 계획대로 진행되고 있다고 느꼈던 적이 얼마나 자주 있었습니까?"], reverseIndices: [4, 5, 7, 8, 10] }
        };

        function toggleAppFeatures(enable) {
            const buttons = document.querySelectorAll('#assessment-buttons button');
            buttons.forEach(btn => btn.disabled = !enable);
            const blocker = document.getElementById('auth-blocker');
            const signoutButton = document.getElementById('signout-button');
            if (enable) { blocker.classList.add('hidden'); signoutButton.classList.remove('hidden'); } 
            else { blocker.classList.remove('hidden'); signoutButton.classList.add('hidden'); }
        }
        
        function displayMessage(type, message) {
            const box = document.getElementById('message-box');
            const title = document.getElementById('message-title');
            const text = document.getElementById('message-text');
            box.className = 'px-4 py-3 rounded-xl mb-6 shadow-sm text-center'; title.className = 'font-bold block mb-1'; text.className = 'block sm:inline';
            if (type === 'error') { box.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700'); title.textContent = '오류 발생!'; } 
            else if (type === 'success') { box.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700'); title.textContent = '알림'; } 
            else { box.classList.add('bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700'); title.textContent = '정보'; }
            text.textContent = message; box.classList.remove('hidden'); setTimeout(() => box.classList.add('hidden'), 8000);
        }

        async function signInUser(email, password) {
            showLoading(true);
