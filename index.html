<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Mind Mirror (MMM)</title>
    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard-dynamic-subset.css" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #375D49; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #F4E8C8; }

        /* New Palette Background */
        body {
            background-color: #F4E8C8; /* Cream Background */
            color: #375D49; /* Dark Green Text */
        }
        
        .font-sans { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
        canvas { width: 100% !important; height: 100% !important; }

        /* Custom Color Classes from Image */
        .text-main { color: #375D49; }
        .border-main { border-color: #375D49; }
        .bg-main { background-color: #375D49; }
        
        /* PHQ-9: Teal Blue (#51A0AF) */
        .bg-teal-custom { background-color: #51A0AF; }
        .text-teal-custom { color: #51A0AF; }
        .hover-bg-teal-custom:hover { background-color: #40808C; }
        
        /* GAD-7: Mustard Yellow (#FFD16D) */
        .bg-mustard-custom { background-color: #FFD16D; }
        .text-mustard-custom { color: #E0B050; } 
        .hover-bg-mustard-custom:hover { background-color: #E5BC62; }

        /* PSS: Vintage Red (#CF4638) */
        .bg-red-custom { background-color: #CF4638; }
        .text-red-custom { color: #CF4638; }
        .hover-bg-red-custom:hover { background-color: #A8382D; }

        /* Card Backgrounds (White with Main Border) */
        .card-custom { 
            background-color: #FFFFFF; 
            border: 1px solid rgba(55, 93, 73, 0.2);
            box-shadow: 0 4px 6px -1px rgba(55, 93, 73, 0.1), 0 2px 4px -1px rgba(55, 93, 73, 0.06);
        }
    </style>
</head>

    <body class="font-sans min-h-screen flex items-center justify-center p-4 relative overflow-y-auto">

    <div id="app" class="w-full max-w-4xl bg-white/95 backdrop-blur-sm shadow-xl rounded-2xl p-6 md:p-10 border border-[#375D49]/20 relative z-10 my-8">

        <!-- Title Wrapper -->
        <div class="relative mb-8 pt-4"> 
            <h1 class="text-3xl font-bold text-main mb-2 text-center relative z-10">My Mind Mirror, MMM (음-)</h1>
            <p class="text-sm text-main/80 text-center relative z-10">1주일에 한 번은 검사를 진행하고, 음- 그렇구나,하고 자기 마음을 알아주세요.</p>
        </div>

        <!-- User Info -->
        <div class="mb-6 flex justify-between items-center text-sm border-b border-[#375D49]/20 pb-4">
            <div id="user-info" class="text-main flex items-center space-x-4">
                <p>사용자 ID: <span id="display-user-id" class="font-mono text-xs bg-[#F4E8C8] px-2 py-1 rounded text-main">인증 필요</span></p>
                <p>상태: <span id="auth-status" class="font-semibold text-red-custom">로드 중...</span></p>
                <button id="signout-button" class="hidden text-xs px-3 py-1 bg-main text-white rounded-lg hover:opacity-90 transition ml-4 shadow-sm">로그아웃</button>
            </div>
            <div id="loading-indicator" class="hidden flex items-center space-x-2 text-teal-custom">
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>처리 중...</span>
            </div>
        </div>

        <!-- Login/Signup Form -->
        <div id="auth-blocker" class="mb-8 p-6 bg-[#F4E8C8]/50 border border-[#375D49]/20 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg text-main mb-2">회원가입/로그인 필요</h3>
            <p class="text-main/80 mb-4 text-sm">개인 정보의 안전한 저장을 위해 이메일과 비밀번호로 회원가입, 로그인 해주세요.</p>
            
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="이메일 주소" required class="w-full p-3 mb-3 border border-[#375D49]/30 rounded-lg focus:ring-2 focus:ring-[#375D49] focus:outline-none text-main bg-white placeholder-main/40">
                <input type="password" id="auth-password" placeholder="비밀번호 (6자 이상)" required class="w-full p-3 mb-4 border border-[#375D49]/30 rounded-lg focus:ring-2 focus:ring-[#375D49] focus:outline-none text-main bg-white placeholder-main/40">
                <div class="flex justify-between items-center">
                    <button type="submit" id="auth-submit-button" data-mode="signin" class="px-6 py-2 bg-main text-white font-bold rounded-lg hover:opacity-90 transition shadow-md">로그인</button>
                    <a href="#" id="auth-mode-toggle" class="text-sm text-teal-custom hover:underline transition font-medium">회원가입 하기</a>
                </div>
            </form>
        </div>

        <!-- Assessment Buttons -->
        <div id="assessment-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <button data-scale="PHQ9" class="p-4 rounded-xl text-white font-bold shadow-md transition-transform transform hover:scale-[1.02] bg-teal-custom hover-bg-teal-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                PHQ-9 (우울) 측정
            </button>
            <button data-scale="GAD7" class="p-4 rounded-xl text-white font-bold shadow-md transition-transform transform hover:scale-[1.02] bg-mustard-custom hover-bg-mustard-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                GAD-7 (불안) 측정
            </button>
            <button data-scale="PSS" class="p-4 rounded-xl text-white font-bold shadow-md transition-transform transform hover:scale-[1.02] bg-red-custom hover-bg-red-custom disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                PSS (스트레스) 측정
            </button>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden px-4 py-3 rounded-xl mb-6 shadow-sm" role="alert">
            <strong id="message-title" class="font-bold"></strong> <span id="message-text"></span>
        </div>

        <!-- Chart Section -->
        <div class="bg-white p-6 rounded-xl border border-[#375D49]/20 shadow-sm">
            <h2 class="text-xl font-semibold text-main mb-6 text-center">나의 MMM (음-) 프로파일</h2>
            <div id="chart-caption" class="text-center text-xs text-main/60 mb-4">데이터가 없습니다. 측정을 시작해 주세요!</div>

            <div class="space-y-10">
                <div class="p-5 rounded-xl bg-white border border-[#51A0AF]/50 shadow-sm">
                    <h3 class="font-bold text-lg text-teal-custom mb-3">우울의 움직임 (PHQ-9)</h3>
                    <div class="relative h-48 md:h-64"><canvas id="phqChart"></canvas></div>
                </div>
                <div class="p-5 rounded-xl bg-white border border-[#FFD16D]/50 shadow-sm">
                    <h3 class="font-bold text-lg text-mustard-custom mb-3">불안의 움직임 (GAD-7)</h3>
                    <div class="relative h-48 md:h-64"><canvas id="gadChart"></canvas></div>
                </div>
                <div class="p-5 rounded-xl bg-white border border-[#CF4638]/50 shadow-sm">
                    <h3 class="font-bold text-lg text-red-custom mb-3">내가 느끼는 스트레스 (PSS)</h3>
                    <div class="relative h-48 md:h-64"><canvas id="pssChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-main mb-4">최근 측정 요약</h2>
            <div id="latest-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-5 card-custom rounded-xl shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-teal-custom"></div>
                    <p class="font-bold text-lg text-teal-custom pl-2">PHQ-9</p>
                    <p class="text-3xl font-extrabold text-main pl-2" id="latest-phq">--</p>
                    <p class="text-xs text-main/70 pl-2">우울 점수 (최대 27점)</p>
                </div>
                <div class="p-5 card-custom rounded-xl shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-mustard-custom"></div>
                    <p class="font-bold text-lg text-mustard-custom pl-2">GAD-7</p>
                    <p class="text-3xl font-extrabold text-main pl-2" id="latest-gad">--</p>
                    <p class="text-xs text-main/70 pl-2">불안 점수 (최대 21점)</p>
                </div>
                <div class="p-5 card-custom rounded-xl shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-red-custom"></div>
                    <p class="font-bold text-lg text-red-custom pl-2">PSS</p>
                    <p class="text-3xl font-extrabold text-main pl-2" id="latest-pss">--</p>
                    <p class="text-xs text-main/70 pl-2">스트레스 점수 (최대 40점)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Modal -->
    <div id="assessment-modal" class="hidden fixed inset-0 bg-[#375D49]/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-300">
            <div id="modal-header" class="p-6 text-white text-xl font-bold rounded-t-xl"><span id="scale-title"></span> 측정</div>
            <div class="p-6 custom-scrollbar max-h-[70vh] overflow-y-auto"><form id="assessment-form"></form></div>
            <div class="p-4 border-t border-gray-100 flex justify-end space-x-3 bg-[#F4E8C8]">
                <button id="cancel-assessment" type="button" class="px-4 py-2 bg-white border border-[#375D49]/20 text-main rounded-lg hover:bg-gray-50 transition">취소</button>
                <button id="submit-assessment" type="submit" form="assessment-form" class="px-4 py-2 text-white rounded-lg font-bold shadow-md transition">결과 저장</button>
            </div>
        </div>
    </div>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = 'my-mind-mirror-mmm-prod'; 
        
        const firebaseConfig = {
            apiKey: "AIzaSyDJ5lpzMYtQP_TrfqXQDF9QTmAVYNU84kE",
            authDomain: "mmm-project-13fb3.firebaseapp.com",
            projectId: "mmm-project-13fb3",
            storageBucket: "mmm-project-13fb3.firebasestorage.app",
            messagingSenderId: "845948284004",
            appId: "1:845948284004:web:aec6d670eb1e656a5a0371",
            measurementId: "G-3TJ21YRM59"
        };

        let app, db, auth, userId = null;
        let phqChartInstance = null, gadChartInstance = null, pssChartInstance = null;
        let scaleData = null;
        
        const CHART_COLORS = {
            PHQ9: { color: '#51A0AF', bgColor: 'transparent' }, // Teal
            GAD7: { color: '#FFD16D', bgColor: 'transparent' }, // Mustard
            PSS: { color: '#CF4638', bgColor: 'transparent' } // Vintage Red
        };

        const CHART_CONFIGS = {
            PHQ9: { id: 'phqChart', label: 'PHQ-9 (우울)', maxScore: 27, prop: 'phq9', instance: 'phqChartInstance', ...CHART_COLORS.PHQ9 },
            GAD7: { id: 'gadChart', label: 'GAD-7 (불안)', maxScore: 21, prop: 'gad7', instance: 'gadChartInstance', ...CHART_COLORS.GAD7 },
            PSS: { id: 'pssChart', label: 'PSS (스트레스)', maxScore: 40, prop: 'pss', instance: 'pssChartInstance', ...CHART_COLORS.PSS }
        };

        const responseOptionsPHQGAD = [{value:0,text:"전혀 없음"},{value:1,text:"몇 일"},{value:2,text:"일주일에 반 이상"},{value:3,text:"거의 매일"}];
        const responseOptionsPSS = [{value:0,text:"전혀 없다"},{value:1,text:"거의 없다"},{value:2,text:"때때로 있다"},{value:3,text:"자주 있다"},{value:4,text:"매우 자주 있다"}];
        const reverseScoreMap = {0:4,1:3,2:2,3:1,4:0};
        
        const assessments = {
            PHQ9: { title: "PHQ-9 (우울증 선별 도구)", colorClass: 'bg-teal-custom', hoverClass: 'hover-bg-teal-custom', options: responseOptionsPHQGAD, questions: ["지난 2주 동안, 다음 문제들로 인해 얼마나 자주 불편을 겪으셨습니까?", "1. 일에 흥미나 즐거움이 거의 없었다.", "2. 기분이 가라앉거나, 우울하거나, 희망이 없다고 느꼈다.", "3. 잠들거나 계속 잠을 자는 데 어려움이 있거나, 너무 많이 잤다.", "4. 피곤하거나 기력이 거의 없었다.", "5. 식욕이 없거나 과식했다.", "6. 자신을 실패자라고 느끼거나, 자신이나 가족을 실망시켰다고 느꼈다.", "7. 신문 읽기나 TV 시청처럼 평소보다 느리게 움직이거나 말을 했고, 다른 사람들이 알아챌 정도였다. 또는 이와 반대로 너무 안절부절못해서 평소보다 많이 움직였다.", "8. 집중하기가 어렵다(예: 신문 읽기, TV 시청 시).", "9. 지난 2주 동안 이 문제들로 인해 직장/학업, 가정 생활, 또는 다른 사람들과의 관계에서 어려움이 있었다면 얼마나 심각했습니까?"].slice(0, 10) },
            GAD7: { title: "GAD-7 (범불안장애 선별 도구)", colorClass: 'bg-mustard-custom', hoverClass: 'hover-bg-mustard-custom', options: responseOptionsPHQGAD, questions: ["지난 2주 동안, 다음 문제들로 인해 얼마나 자주 불편을 겪으셨습니까?", "1. 안절부절못하거나 평온하게 있을 수 없었다.", "2. 쉽게 짜증을 내거나 신경이 곤두서 있었다.", "3. 무엇인가 걱정하는 것을 멈출 수 없거나 조절할 수 없었다.", "4. 지나치게 걱정했다.", "5. 여러 가지 일에 대해 너무 걱정했다.", "6. 불안 때문에 휴식을 취하기 어려웠다.", "7. 너무 걱정되어서 잠들기가 어려웠다."] },
            PSS: { title: "PSS-10 (지각된 스트레스 척도)", colorClass: 'bg-red-custom', hoverClass: 'hover-bg-red-custom', options: responseOptionsPSS, questions: ["지난 한 달 동안, 다음 각 질문의 상황이 얼마나 자주 있었는지 응답해 주십시오. (10문항)", "1. 예기치 않은 일들 때문에 당황했던 적이 얼마나 자주 있었습니까?", "2. 생활의 중요한 일들을 통제할 수 없다고 느꼈던 적이 얼마나 자주 있었습니까?", "3. 신경이 예민해지고 스트레스를 받았다고 느꼈던 적이 얼마나 자주 있었습니까?", "4. 생활 속에서 일어나는 일들을 처리하는 데 효과적으로 대처한다고 느꼈던 적이 얼마나 자주 있었습니까?", "5. 당신에게 중요한 일들을 완벽하게 처리할 수 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "6. 당신이 통제할 수 없었던 일들 때문에 화가 났던 적이 얼마나 자주 있었습니까?", "7. 사소한 일들에 대해 성공적으로 대처한다고 느꼈던 적이 얼마나 자주 있었습니까?", "8. 쌓여 있는 일들을 잘 처리하고 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "9. 당신이 감당할 수 없을 정도로 많은 일들이 쌓여 있다고 느꼈던 적이 얼마나 자주 있었습니까?", "10. 당신의 개인적인 일들이 계획대로 진행되고 있다고 느꼈던 적이 얼마나 자주 있었습니까?"], reverseIndices: [4, 5, 7, 8, 10] }
        };

        function toggleAppFeatures(enable) {
            const buttons = document.querySelectorAll('#assessment-buttons button');
            buttons.forEach(btn => btn.disabled = !enable);
            const blocker = document.getElementById('auth-blocker');
            const signoutButton = document.getElementById('signout-button');
            if (enable) { blocker.classList.add('hidden'); signoutButton.classList.remove('hidden'); } 
            else { blocker.classList.remove('hidden'); signoutButton.classList.add('hidden'); }
        }
        
        function displayMessage(type, message) {
            const box = document.getElementById('message-box');
            const title = document.getElementById('message-title');
            const text = document.getElementById('message-text');
            box.className = 'px-4 py-3 rounded-xl mb-6 shadow-sm'; title.className = 'font-bold'; text.className = 'block sm:inline';
            if (type === 'error') { box.classList.add('bg-[#CF4638]/10', 'border', 'border-[#CF4638]', 'text-[#CF4638]'); title.textContent = '오류 발생:'; } 
            else if (type === 'success') { box.classList.add('bg-[#51A0AF]/20', 'border', 'border-[#51A0AF]', 'text-[#375D49]'); title.textContent = '알림:'; } 
            else { box.classList.add('bg-[#FFD16D]/20', 'border', 'border-[#FFD16D]', 'text-[#375D49]'); title.textContent = '정보:'; }
            text.textContent = message; box.classList.remove('hidden'); setTimeout(() => box.classList.add('hidden'), 8000);
        }

        async function signInUser(email, password) {
            showLoading(true);
            try { await signInWithEmailAndPassword(auth, email, password); displayMessage('success', "로그인 성공!"); } 
            catch (error) { console.error(error); displayMessage('error', `로그인 실패: ${error.message}`); } 
            finally { showLoading(false); }
        }

        async function signUpUser(email, password) {
            showLoading(true);
            try { await createUserWithEmailAndPassword(auth, email, password); displayMessage('success', "회원가입 및 로그인 완료!"); } 
            catch (error) { console.error(error); displayMessage('error', `회원가입 실패: ${error.message}`); } 
            finally { showLoading(false); }
        }
        
        function handleSignOut() {
            showLoading(true);
            signOut(auth).then(() => { displayMessage('success', "로그아웃되었습니다."); }).catch((error) => { displayMessage('error', "로그아웃 오류"); }).finally(() => { showLoading(false); });
        }
        
        async function initFirebase() {
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.getElementById('auth-status').textContent = '설정 오류';
                displayMessage('error', "Firebase 설정을 확인해주세요."); toggleAppFeatures(false); return;
            }
            try {
                setLogLevel('error'); app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
                document.getElementById('auth-status').textContent = '로그인 대기 중...';
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; document.getElementById('auth-status').textContent = `인증 완료`; document.getElementById('display-user-id').textContent = userId; toggleAppFeatures(true); setupRealtimeListener(); } 
                    else { userId = null; document.getElementById('auth-status').textContent = '로그인 필요'; document.getElementById('display-user-id').textContent = '인증 필요'; toggleAppFeatures(false); updateCharts([]); updateSummary([]); }
                });
            } catch (error) { console.error(error); displayMessage('error', "Firebase 초기화 실패"); toggleAppFeatures(false); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('auth-form');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authModeToggle = document.getElementById('auth-mode-toggle');
            if(authForm) {
                authForm.addEventListener('submit', function(e) { e.preventDefault(); const email = document.getElementById('auth-email').value; const password = document.getElementById('auth-password').value; const mode = authSubmitButton.dataset.mode; if (mode === 'signin') { signInUser(email, password); } else { signUpUser(email, password); } });
                authModeToggle.addEventListener('click', function(e) { e.preventDefault(); if (authSubmitButton.dataset.mode === 'signin') { authSubmitButton.dataset.mode = 'signup'; authSubmitButton.textContent = '회원가입'; authModeToggle.textContent = '로그인 화면으로 돌아가기'; } else { authSubmitButton.dataset.mode = 'signin'; authSubmitButton.textContent = '로그인'; authModeToggle.textContent = '회원가입 하기'; } });
            }
            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            initFirebase();
        });
        
        function getCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/stress_trackers`);
        }

        function setupRealtimeListener() {
            const colRef = getCollectionRef(); if (!colRef) return;
            onSnapshot(colRef, (snapshot) => {
                const results = []; snapshot.forEach((doc) => { results.push({ id: doc.id, ...doc.data() }); });
                
                // Smart Deduplication
                results.sort((a, b) => (a.timestamp ? a.timestamp.toDate() : 0)
