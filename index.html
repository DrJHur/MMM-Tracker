<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ì œëª© ë³€ê²½: My Mind Mirror (MMM) -->
    <title> My Mind Mirror, MMM (ìŒ-))</title>
    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard-dynamic-subset.css" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #a7f3d0; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #f7f7f7; }

        /* Updated Background Gradient: Slightly more vivid pastel colors */
        body {
            /* ì—°ë³´ë¼(#e6d6ff), ì—°ë‘(#d6ffe1), ì—°ë…¸ë‘(#fff5d6), ì—°í•‘í¬(#ffd6e6) */
            background: linear-gradient(135deg, #e6d6ff 0%, #d6ffe1 25%, #fff5d6 50%, #ffd6e6 75%);
            background-attachment: fixed; 
        }
        
        /* Unified Color Palette: Very light Sky for card backgrounds (lighter than Sky 100) */
        .phq-card-color, .gad-card-color, .pss-card-color { 
            background-color: #f0f8ff; /* Very light azure/sky for a softer look */ 
        }
        
        /* Pretendard Font Application */
        .font-sans { 
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;
        }

        /* Ensure Canvas element height is flexible within its container */
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body class="font-sans min-h-screen flex items-center justify-center p-4 relative overflow-y-auto">
    
    <!-- Cloud Motif Background Elements (ëª½ì‹¤ëª½ì‹¤ í° êµ¬ë¦„ ëŠë‚Œ) -->
    <div class="cloud-motif absolute bg-white rounded-full opacity-60 w-64 h-64 -top-10 -left-10 blur-3xl shadow-xl animate-pulse" style="animation-delay: 0s;"></div>
    <div class="cloud-motif absolute bg-white rounded-full opacity-40 w-96 h-96 -bottom-32 -right-32 blur-3xl shadow-2xl animate-pulse" style="animation-delay: 2s;"></div>
    <div class="cloud-motif absolute bg-white rounded-full opacity-50 w-48 h-48 top-1/4 left-1/3 blur-2xl shadow-lg animate-pulse" style="animation-delay: 4s;"></div>

    <!-- Main Container -->
    <div id="app" class="w-full max-w-4xl bg-white/90 backdrop-blur-sm shadow-2xl rounded-2xl p-6 md:p-10 border border-gray-100 relative z-10 my-8">

        <!-- Title and Cloud Wrapper -->
        <div class="relative mb-8 pt-4"> 
            <!-- New Cloud Element (Behind the Title) -->
            <div class="absolute inset-x-0 -top-6 flex justify-center items-center z-0 opacity-80 pointer-events-none">
                <!-- Simple SVG Cloud for aesthetic backdrop -->
                <svg class="w-96 h-48 text-white fill-current blur-md shadow-lg" viewBox="0 0 100 40" preserveAspectRatio="none">
                    <path d="M 5 25 C 5 10, 20 5, 30 10 S 45 5, 60 10 S 75 5, 90 15 C 95 25, 80 35, 70 30 C 70 35, 60 38, 50 35 C 40 38, 30 35, 30 30 C 20 35, 15 30, 10 25 Z" />
                </svg>
            </div>

            <!-- Title Change - Centered -->
            <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center relative z-10"> My Mind Mirror, MMM (ìŒ-)</h1>
            <!-- Text Change - Centered -->
            <p class="text-sm text-gray-500 text-center relative z-10">1ì£¼ì¼ì— í•œ ë²ˆì€ ê²€ì‚¬ë¥¼ ì§„í–‰í•˜ê³ , ìŒ- ê·¸ë ‡êµ¬ë‚˜,í•˜ê³  ìê¸° ë§ˆìŒì„ ì•Œì•„ì£¼ì„¸ìš”. </p>
        </div>

        <!-- User Info & Loading -->
        <div class="mb-6 flex justify-between items-center text-sm">
            <div id="user-info" class="text-gray-600 flex items-center space-x-4">
                <!-- ì „ì²´ ì‚¬ìš©ì ID í‘œì‹œí•˜ë„ë¡ ë³€ê²½ -->
                <p>ì‚¬ìš©ì ID: <span id="display-user-id" class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">ì¸ì¦ í•„ìš”</span></p>
                <p class="mt-1">ì¸ì¦ ìƒíƒœ: <span id="auth-status" class="font-semibold text-red-500">ì¸ì¦ ë¡œë“œ ì¤‘...</span></p>
                <!-- Sign-out Button -->
                <button id="signout-button" class="hidden text-xs px-2 py-1 bg-red-400 text-white rounded-lg hover:bg-red-500 transition ml-4">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="loading-indicator" class="hidden flex items-center space-x-2 text-blue-500">
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <span>ì²˜ë¦¬ ì¤‘...</span>
            </div>
        </div>

        <!-- Authentication Prompt/Blocker - Now includes Login Form -->
        <div id="auth-blocker" class="mb-6 p-6 bg-red-50 border border-red-300 rounded-xl">
            <h3 class="font-bold text-lg text-red-700 mb-2"> íšŒì›ê°€ì…/ë¡œê·¸ì¸ í•„ìš”</h3>
            <p class="text-red-600 mb-4">ê°œì¸ ì •ë³´ì˜ ì•ˆì „í•œ ì €ì¥ì„ ìœ„í•´ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ íšŒì›ê°€ì…/ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.</p>
            
            <!-- Login/Signup Form UI -->
            <form id="auth-form">
                <input type="email" id="auth-email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" required 
                       class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 text-gray-800">
                <input type="password" id="auth-password" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" required 
                       class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 text-gray-800">
                
                <div class="flex justify-between items-center">
                    <button type="submit" id="auth-submit-button" data-mode="signin"
                            class="px-5 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition">
                        ë¡œê·¸ì¸
                    </button>
                    <a href="#" id="auth-mode-toggle" class="text-sm text-sky-600 hover:text-sky-700 transition">
                        íšŒì›ê°€ì… í•˜ê¸°
                    </a>
                </div>
            </form>
        </div>

        <!-- Assessment Buttons (Unified Sky Blue - Lighter 400) -->
        <div id="assessment-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <!-- Unified Sky Blue Button -->
            <button data-scale="PHQ9" class="p-4 rounded-xl text-white font-semibold shadow-lg transition-transform transform hover:scale-[1.02] bg-sky-400 hover:bg-sky-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                PHQ-9 (ìš°ìš¸) ì¸¡ì •
            </button>
            <!-- Unified Sky Blue Button -->
            <button data-scale="GAD7" class="p-4 rounded-xl text-white font-semibold shadow-lg transition-transform transform hover:scale-[1.02] bg-sky-400 hover:bg-sky-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                GAD-7 (ë¶ˆì•ˆ) ì¸¡ì •
            </button>
            <!-- Unified Sky Blue Button -->
            <button data-scale="PSS" class="p-4 rounded-xl text-white font-semibold shadow-lg transition-transform transform hover:scale-[1.02] bg-sky-400 hover:bg-sky-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                PSS (ìŠ¤íŠ¸ë ˆìŠ¤) ì¸¡ì •
            </button>
        </div>

        <!-- Message Area HTML Structure Adjustment -->
        <div id="message-box" class="hidden px-4 py-3 rounded-xl mb-6" role="alert">
            <strong id="message-title" class="font-bold"></strong>
            <span id="message-text" class="block sm:inline"></span>
        </div>

        <!-- Chart Section (Now individual charts) -->
        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
            <!-- Subtitle Change - Added text-center -->
            <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center"> ë‚˜ì˜ MMM (ìŒ-) í”„ë¡œíŒŒì¼ </h2>
            
            <div id="chart-caption" class="text-center text-sm text-gray-500 mb-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¸¡ì •ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”!</div>

            <div class="space-y-8">
                <!-- PHQ-9 Chart (Title changed to ì¼ì§€) -->
                <div class="p-4 rounded-lg bg-white shadow-md border border-gray-100">
                    <h3 class="font-bold text-lg text-gray-800 mb-3">ìš°ìš¸ì˜ ì›€ì§ì„ (PHQ-9) </h3>
                    <div class="relative h-48 md:h-64">
                        <canvas id="phqChart"></canvas>
                    </div>
                </div>

                <!-- GAD-7 Chart (Title changed to ì¼ì§€) -->
                <div class="p-4 rounded-lg bg-white shadow-md border border-gray-100">
                    <h3 class="font-bold text-lg text-gray-800 mb-3">ë¶ˆì•ˆì˜ ì›€ì§ì„ (GAD-7) </h3>
                    <div class="relative h-48 md:h-64">
                        <canvas id="gadChart"></canvas>
                    </div>
                </div>

                <!-- PSS Chart (Title changed to ì¼ì§€) -->
                <div class="p-4 rounded-lg bg-white shadow-md border border-gray-100">
                    <h3 class="font-bold text-lg text-gray-800 mb-3">ë‚´ê°€ ëŠë¼ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ (PSS) </h3>
                    <div class="relative h-48 md:h-64">
                        <canvas id="pssChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Measurement Summary (Text color unified to gray/black) -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ìµœê·¼ ì¸¡ì • ìš”ì•½</h2>
            <div id="latest-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- PHQ-9 Summary: Unified Card Color, Text Gray/Black -->
                <div class="p-4 phq-card-color rounded-xl shadow-md">
                    <p class="font-bold text-lg text-gray-800">PHQ-9</p>
                    <p class="text-3xl font-extrabold text-gray-900" id="latest-phq">--</p>
                    <p class="text-sm text-gray-600">ìš°ìš¸ ì ìˆ˜ (ìµœëŒ€ 27ì )</p>
                </div>
                <!-- GAD-7 Summary: Unified Card Color, Text Gray/Black -->
                <div class="p-4 gad-card-color rounded-xl shadow-md">
                    <p class="font-bold text-lg text-gray-800">GAD-7</p>
                    <p class="text-3xl font-extrabold text-gray-900" id="latest-gad">--</p>
                    <p class="text-sm text-gray-600">ë¶ˆì•ˆ ì ìˆ˜ (ìµœëŒ€ 21ì )</p>
                </div>
                <!-- PSS Summary: Unified Card Color, Text Gray/Black -->
                <div class="p-4 pss-card-color rounded-xl shadow-md">
                    <p class="font-bold text-lg text-gray-800">PSS</p>
                    <p class="text-3xl font-extrabold text-gray-900" id="latest-pss">--</p>
                    <p class="text-sm text-gray-600">ì§€ê°ëœ ìŠ¤íŠ¸ë ˆìŠ¤ ì ìˆ˜ (ìµœëŒ€ 40ì )</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Assessment Modal (Unified Sky Blue - Lighter 400) -->
    <div id="assessment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all duration-300">
            <!-- Modal Header Unified Sky Blue -->
            <div id="modal-header" class="p-6 text-white text-xl font-bold rounded-t-xl bg-sky-400">
                <span id="scale-title"></span> ì¸¡ì •
            </div>
            
            <div class="p-6 custom-scrollbar max-h-[70vh] overflow-y-auto">
                <form id="assessment-form">
                    <!-- Questions will be dynamically inserted here -->
                </form>
            </div>

            <div class="p-4 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancel-assessment" type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">ì·¨ì†Œ</button>
                <!-- Submit button unified Sky Blue -->
                <button id="submit-assessment" type="submit" form="assessment-form" class="px-4 py-2 bg-sky-400 text-white rounded-lg hover:bg-sky-500 font-semibold transition">ê²°ê³¼ ì €ì¥</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Authentication ê¸°ëŠ¥ì„ ìœ„í•´ í•„ìš”í•œ í•¨ìˆ˜ë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ğŸš¨ ì‚¬ìš©ìë‹˜ì˜ ì‹¤ì œ Firebase ì„¤ì •ì´ í•„ìš”í•œ ë¶€ë¶„ ğŸš¨ ---
        // ì´ ì„¤ì • ê°ì²´ëŠ” ì‚¬ìš©ìë‹˜ê»˜ì„œ ì´ì „ì— ì‚½ì…í•˜ì‹  ë‚´ìš©ìœ¼ë¡œ, ì‘ë™í•œë‹¤ê³  ê°€ì •í•˜ê³  ì‚¬ìš©í•©ë‹ˆë‹¤.
        
        const appId = 'my-mind-mirror-mmm-prod'; // ì•± ID
        const firebaseConfig = {
            apiKey: "AIzaSyDJ5lpzMYtQP_TrfqXQDF9QTmAVYNU84kE",
            authDomain: "mmm-project-13fb3.firebaseapp.com",
            projectId: "mmm-project-13fb3",
            storageBucket: "mmm-project-13fb3.firebasestorage.app",
            messagingSenderId: "845948284004",
            appId: "1:845948284004:web:aec6d670eb1e656a5a0371",
            measurementId: "G-3TJ21YRM59"
        };
        // NOTE: ì¤‘ë³µëœ Firebase Config ì„ ì–¸ì€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.

        // --- ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
        let app, db, auth, userId = null;
        let phqChartInstance = null;
        let gadChartInstance = null;
        let pssChartInstance = null;
        let scaleData = null;
        
        // --- ìƒ‰ìƒ ë° UI ì„¤ì • ---
        const CHART_COLOR_UNIFIED = 'rgb(56, 189, 248)'; // Sky 400
        const CHART_BG_COLOR_UNIFIED = 'rgba(56, 189, 248, 0.2)';
        const BUTTON_COLOR_CLASS = "bg-sky-400";
        const BUTTON_HOVER_CLASS = "hover:bg-sky-500";
        
        // --- ì°¨íŠ¸ ì„¤ì • ìƒìˆ˜ ---
        const CHART_CONFIGS = {
            PHQ9: { id: 'phqChart', label: 'PHQ-9 (ìš°ìš¸)', maxScore: 27, color: CHART_COLOR_UNIFIED, bgColor: CHART_BG_COLOR_UNIFIED, prop: 'phq9', instance: 'phqChartInstance' },
            GAD7: { id: 'gadChart', label: 'GAD-7 (ë¶ˆì•ˆ)', maxScore: 21, color: CHART_COLOR_UNIFIED, bgColor: CHART_BG_COLOR_UNIFIED, prop: 'gad7', instance: 'gadChartInstance' },
            PSS: { id: 'pssChart', label: 'PSS (ìŠ¤íŠ¸ë ˆìŠ¤)', maxScore: 40, color: CHART_COLOR_UNIFIED, bgColor: CHART_BG_COLOR_UNIFIED, prop: 'pss', instance: 'pssChartInstance' }
        };

        // --- ì„¤ë¬¸ ë¬¸í•­ ë° ì˜µì…˜ (ê°€ë…ì„±ì„ ìœ„í•´ ìƒëµ) ---
        const responseOptionsPHQGAD = [ { value: 0, text: "ì „í˜€ ì—†ìŒ" }, { value: 1, text: "ëª‡ ì¼" }, { value: 2, text: "ì¼ì£¼ì¼ì— ë°˜ ì´ìƒ" }, { value: 3, text: "ê±°ì˜ ë§¤ì¼" }];
        const responseOptionsPSS = [ { value: 0, text: "ì „í˜€ ì—†ë‹¤" }, { value: 1, text: "ê±°ì˜ ì—†ë‹¤" }, { value: 2, text: "ë•Œë•Œë¡œ ìˆë‹¤" }, { value: 3, text: "ìì£¼ ìˆë‹¤" }, { value: 4, text: "ë§¤ìš° ìì£¼ ìˆë‹¤" }];
        const reverseScoreMap = { 0: 4, 1: 3, 2: 2, 3: 1, 4: 0 };
        const assessments = {
            PHQ9: {
                title: "PHQ-9 (ìš°ìš¸ì¦ ì„ ë³„ ë„êµ¬)",
                color: BUTTON_COLOR_CLASS, options: responseOptionsPHQGAD,
                questions: ["ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ë‹¤ìŒ ë¬¸ì œë“¤ë¡œ ì¸í•´ ì–¼ë§ˆë‚˜ ìì£¼ ë¶ˆí¸ì„ ê²ªìœ¼ì…¨ìŠµë‹ˆê¹Œ?", "1. ì¼ì— í¥ë¯¸ë‚˜ ì¦ê±°ì›€ì´ ê±°ì˜ ì—†ì—ˆë‹¤.", "2. ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, í¬ë§ì´ ì—†ë‹¤ê³  ëŠê¼ˆë‹¤.", "3. ì ë“¤ê±°ë‚˜ ê³„ì† ì ì„ ìëŠ” ë° ì–´ë ¤ì›€ì´ ìˆê±°ë‚˜, ë„ˆë¬´ ë§ì´ ì¤ë‹¤.", "4. í”¼ê³¤í•˜ê±°ë‚˜ ê¸°ë ¥ì´ ê±°ì˜ ì—†ì—ˆë‹¤.", "5. ì‹ìš•ì´ ì—†ê±°ë‚˜ ê³¼ì‹í–ˆë‹¤.", "6. ìì‹ ì„ ì‹¤íŒ¨ìë¼ê³  ëŠë¼ê±°ë‚˜, ìì‹ ì´ë‚˜ ê°€ì¡±ì„ ì‹¤ë§ì‹œì¼°ë‹¤ê³  ëŠê¼ˆë‹¤.", "7. ì‹ ë¬¸ ì½ê¸°ë‚˜ TV ì‹œì²­ì²˜ëŸ¼ í‰ì†Œë³´ë‹¤ ëŠë¦¬ê²Œ ì›€ì§ì´ê±°ë‚˜ ë§ì„ í–ˆê³ , ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ì•Œì•„ì±Œ ì •ë„ì˜€ë‹¤. ë˜ëŠ” ì´ì™€ ë°˜ëŒ€ë¡œ ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆëª»í•´ì„œ í‰ì†Œë³´ë‹¤ ë§ì´ ì›€ì§ì˜€ë‹¤.", "8. ì§‘ì¤‘í•˜ê¸°ê°€ ì–´ë µë‹¤(ì˜ˆ: ì‹ ë¬¸ ì½ê¸°, TV ì‹œì²­ ì‹œ).", "9. ì§€ë‚œ 2ì£¼ ë™ì•ˆ ì´ ë¬¸ì œë“¤ë¡œ ì¸í•´ ì§ì¥/í•™ì—…, ê°€ì • ìƒí™œ, ë˜ëŠ” ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„ì—ì„œ ì–´ë ¤ì›€ì´ ìˆì—ˆë‹¤ë©´ ì–¼ë§ˆë‚˜ ì‹¬ê°í–ˆìŠµë‹ˆê¹Œ?"].slice(0, 10) 
            },
            GAD7: {
                title: "GAD-7 (ë²”ë¶ˆì•ˆì¥ì•  ì„ ë³„ ë„êµ¬)",
                color: BUTTON_COLOR_CLASS, options: responseOptionsPHQGAD,
                questions: ["ì§€ë‚œ 2ì£¼ ë™ì•ˆ, ë‹¤ìŒ ë¬¸ì œë“¤ë¡œ ì¸í•´ ì–¼ë§ˆë‚˜ ìì£¼ ë¶ˆí¸ì„ ê²ªìœ¼ì…¨ìŠµë‹ˆê¹Œ?", "1. ì•ˆì ˆë¶€ì ˆëª»í•˜ê±°ë‚˜ í‰ì˜¨í•˜ê²Œ ìˆì„ ìˆ˜ ì—†ì—ˆë‹¤.", "2. ì‰½ê²Œ ì§œì¦ì„ ë‚´ê±°ë‚˜ ì‹ ê²½ì´ ê³¤ë‘ì„œ ìˆì—ˆë‹¤.", "3. ë¬´ì—‡ì¸ê°€ ê±±ì •í•˜ëŠ” ê²ƒì„ ë©ˆì¶œ ìˆ˜ ì—†ê±°ë‚˜ ì¡°ì ˆí•  ìˆ˜ ì—†ì—ˆë‹¤.", "4. ì§€ë‚˜ì¹˜ê²Œ ê±±ì •í–ˆë‹¤.", "5. ì—¬ëŸ¬ ê°€ì§€ ì¼ì— ëŒ€í•´ ë„ˆë¬´ ê±±ì •í–ˆë‹¤.", "6. ë¶ˆì•ˆ ë•Œë¬¸ì— íœ´ì‹ì„ ì·¨í•˜ê¸° ì–´ë ¤ì› ë‹¤.", "7. ë„ˆë¬´ ê±±ì •ë˜ì–´ì„œ ì ë“¤ê¸°ê°€ ì–´ë ¤ì› ë‹¤."]
            },
            PSS: {
                title: "PSS-10 (ì§€ê°ëœ ìŠ¤íŠ¸ë ˆìŠ¤ ì²™ë„)",
                color: BUTTON_COLOR_CLASS, options: responseOptionsPSS,
                questions: ["ì§€ë‚œ í•œ ë‹¬ ë™ì•ˆ, ë‹¤ìŒ ê° ì§ˆë¬¸ì˜ ìƒí™©ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆëŠ”ì§€ ì‘ë‹µí•´ ì£¼ì‹­ì‹œì˜¤. (10ë¬¸í•­)", "1. ì˜ˆê¸°ì¹˜ ì•Šì€ ì¼ë“¤ ë•Œë¬¸ì— ë‹¹í™©í–ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "2. ìƒí™œì˜ ì¤‘ìš”í•œ ì¼ë“¤ì„ í†µì œí•  ìˆ˜ ì—†ë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "3. ì‹ ê²½ì´ ì˜ˆë¯¼í•´ì§€ê³  ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì•˜ë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "4. ìƒí™œ ì†ì—ì„œ ì¼ì–´ë‚˜ëŠ” ì¼ë“¤ì„ ì²˜ë¦¬í•˜ëŠ” ë° íš¨ê³¼ì ìœ¼ë¡œ ëŒ€ì²˜í•œë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "5. ë‹¹ì‹ ì—ê²Œ ì¤‘ìš”í•œ ì¼ë“¤ì„ ì™„ë²½í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "6. ë‹¹ì‹ ì´ í†µì œí•  ìˆ˜ ì—†ì—ˆë˜ ì¼ë“¤ ë•Œë¬¸ì— í™”ê°€ ë‚¬ë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "7. ì‚¬ì†Œí•œ ì¼ë“¤ì— ëŒ€í•´ ì„±ê³µì ìœ¼ë¡œ ëŒ€ì²˜í•œë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "8. ìŒ“ì—¬ ìˆëŠ” ì¼ë“¤ì„ ì˜ ì²˜ë¦¬í•˜ê³  ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "9. ë‹¹ì‹ ì´ ê°ë‹¹í•  ìˆ˜ ì—†ì„ ì •ë„ë¡œ ë§ì€ ì¼ë“¤ì´ ìŒ“ì—¬ ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?", "10. ë‹¹ì‹ ì˜ ê°œì¸ì ì¸ ì¼ë“¤ì´ ê³„íšëŒ€ë¡œ ì§„í–‰ë˜ê³  ìˆë‹¤ê³  ëŠê¼ˆë˜ ì ì´ ì–¼ë§ˆë‚˜ ìì£¼ ìˆì—ˆìŠµë‹ˆê¹Œ?"],
                reverseIndices: [4, 5, 7, 8, 10]
            }
        };

        // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ê´€ë¦¬ ---

        function toggleAppFeatures(enable) {
            const buttons = document.querySelectorAll('#assessment-buttons button');
            buttons.forEach(btn => btn.disabled = !enable);
            
            const blocker = document.getElementById('auth-blocker');
            const signoutButton = document.getElementById('signout-button');
            
            if (enable) {
                blocker.classList.add('hidden');
                signoutButton.classList.remove('hidden');
            } else {
                blocker.classList.remove('hidden');
                signoutButton.classList.add('hidden');
            }
        }
        
        // --- Utility Functions: ë©”ì‹œì§€ í‘œì‹œ í†µí•© ---
        function displayMessage(type, message) {
            const box = document.getElementById('message-box');
            const title = document.getElementById('message-title');
            const text = document.getElementById('message-text');

            // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            box.className = 'px-4 py-3 rounded-xl mb-6';
            title.className = 'font-bold';
            text.className = 'block sm:inline';

            if (type === 'error') {
                box.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
                title.textContent = 'ì˜¤ë¥˜ ë°œìƒ:';
            } else if (type === 'success') {
                box.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
                title.textContent = 'ì•Œë¦¼:';
            } else {
                 box.classList.add('bg-gray-100', 'border', 'border-gray-400', 'text-gray-700');
                 title.textContent = 'ì •ë³´:';
            }

            text.textContent = message;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 8000);
        }

        // ëª¨ë“  ì˜¤ë¥˜ ì²˜ë¦¬ëŠ” displayMessage('error', ...)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // Identifier 'showError' has already been declared ì˜¤ë¥˜ë¥¼ í”¼í•˜ê¸° ìœ„í•´ const showError ì •ì˜ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
        
        // --- ì¸ì¦ ë¡œì§ í•¨ìˆ˜ ---

        async function signInUser(email, password) {
            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                displayMessage('success', "ë¡œê·¸ì¸ ì„±ê³µ!"); 
            } catch (error) {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error.code, error.message);
                displayMessage('error', `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message.split('(')[0] || "ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."}`);
            } finally {
                showLoading(false);
            }
        }

        async function signUpUser(email, password) {
            showLoading(true);
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                displayMessage('success', "íšŒì›ê°€ì… ë° ìë™ ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); 
            } catch (error) {
                console.error("íšŒì›ê°€ì… ì‹¤íŒ¨:", error.code, error.message);
                displayMessage('error', `íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message.split('(')[0] || "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³„ì •ì´ê±°ë‚˜ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤."}`); 
            } finally {
                showLoading(false);
            }
        }
        
        function handleSignOut() {
            showLoading(true);
            signOut(auth).then(() => {
                displayMessage('success', "ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤."); 
            }).catch((error) => {
                displayMessage('error', "ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
            }).finally(() => {
                showLoading(false);
            });
        }
        
        async function initFirebase() {
            // Firebase ì„¤ì • ê°ì²´ê°€ ë¹„ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.getElementById('auth-status').textContent = 'ì„¤ì • ì˜¤ë¥˜';
                displayMessage('error', "Firebase ì„¤ì •ì´ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. index.html íŒŒì¼ì„ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.");
                toggleAppFeatures(false);
                return;
            }

            try {
                setLogLevel('error');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                document.getElementById('auth-status').textContent = 'ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘...';
                
                // onAuthStateChanged: ì‚¬ìš©ì ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ë³€í™”ë¥¼ ê°ì§€
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // ë¡œê·¸ì¸ ì„±ê³µ: userId ì„¤ì • ë° UI ì—…ë°ì´íŠ¸
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = `ì¸ì¦ ì™„ë£Œ`;
                        document.getElementById('display-user-id').textContent = userId;
                        toggleAppFeatures(true);
                        setupRealtimeListener();
                    } else {
                        // ë¡œê·¸ì•„ì›ƒ ë˜ëŠ” ì¸ì¦ ì‹¤íŒ¨: UI ì—…ë°ì´íŠ¸ ë° ê¸°ëŠ¥ ë¹„í™œì„±í™”
                        userId = null;
                        document.getElementById('auth-status').textContent = 'ë¡œê·¸ì¸ í•„ìš”';
                        document.getElementById('display-user-id').textContent = 'ì¸ì¦ í•„ìš”';
                        toggleAppFeatures(false);
                        // ì°¨íŠ¸ ë° ìš”ì•½ ë°ì´í„° ì´ˆê¸°í™”
                        updateCharts([]);
                        updateSummary([]);
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                displayMessage('error', "Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                toggleAppFeatures(false);
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---

        document.addEventListener('DOMContentLoaded', () => {
            const authForm = document.getElementById('auth-form');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authModeToggle = document.getElementById('auth-mode-toggle');
            
            if(authForm) {
                authForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const email = document.getElementById('auth-email').value;
                    const password = document.getElementById('auth-password').value;
                    const mode = authSubmitButton.dataset.mode;

                    if (mode === 'signin') {
                        signInUser(email, password);
                    } else {
                        signUpUser(email, password);
                    }
                });

                authModeToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (authSubmitButton.dataset.mode === 'signin') {
                        authSubmitButton.dataset.mode = 'signup';
                        authSubmitButton.textContent = 'íšŒì›ê°€ì…';
                        authModeToggle.textContent = 'ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°';
                    } else {
                        authSubmitButton.dataset.mode = 'signin';
                        authSubmitButton.textContent = 'ë¡œê·¸ì¸';
                        authModeToggle.textContent = 'íšŒì›ê°€ì… í•˜ê¸°';
                    }
                });
            }

            document.getElementById('signout-button').addEventListener('click', handleSignOut);
            
            initFirebase();
        });
        
        // --- Firestore Data Operations (ì´í•˜ ë°ì´í„° ë° ì°¨íŠ¸ ë¡œì§ì€ ìœ ì§€) ---

        function getCollectionRef() {
            if (!db || !userId) return null;
            // Private data path: /artifacts/{appId}/users/{userId}/stress_trackers
            const path = `artifacts/${appId}/users/${userId}/stress_trackers`;
            return collection(db, path);
        }

        function setupRealtimeListener() {
            const colRef = getCollectionRef();
            if (!colRef) return;
            
            // ë°ì´í„° ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            onSnapshot(colRef, (snapshot) => {
                const results = [];
                snapshot.forEach((doc) => { results.push({ id: doc.id, ...doc.data() }); });
                results.sort((a, b) => (a.timestamp ? a.timestamp.toDate() : 0) - (b.timestamp ? b.timestamp.toDate() : 0));
                
                scaleData = results;
                updateCharts(scaleData);
                updateSummary(scaleData);
            }, (error) => {
                console.error("ë°ì´í„° ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:", error);
                displayMessage('error', "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        }
        
        async function saveAssessmentResult(result) {
            const colRef = getCollectionRef();
            if (!colRef) {
                displayMessage('error', "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜: ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                return;
            }
            
            showLoading(true);
            try {
                await addDoc(colRef, { ...result, timestamp: serverTimestamp() });
                displayMessage('success', "ì¸¡ì • ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"); // ìˆ˜ì •: displayMessage ì‚¬ìš©
            } catch (error) {
                console.error("ì¸¡ì • ê²°ê³¼ ì €ì¥ ì˜¤ë¥˜:", error);
                displayMessage('error', "ì¸¡ì • ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); // ìˆ˜ì •: displayMessage ì‚¬ìš©
            } finally {
                showLoading(false);
            }
        }

        // --- Chart & UI Rendering ---
        
        function createOrUpdateChart(chartId, dataLabels, scoreData, config) {
            const ctx = document.getElementById(chartId).getContext('2d');
            let instance;
            if (config.instance === 'phqChartInstance') instance = phqChartInstance;
            else if (config.instance === 'gadChartInstance') instance = gadChartInstance;
            else if (config.instance === 'pssChartInstance') instance = pssChartInstance;

            if (instance) {
                instance.data.labels = dataLabels;
                instance.data.datasets[0].data = scoreData;
                instance.update();
                return instance;
            }

            const newInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataLabels,
                    datasets: [{
                        label: config.label, data: scoreData, borderColor: config.color, backgroundColor: config.bgColor,
                        tension: 0.4, fill: true, pointBackgroundColor: config.color, borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: true } },
                    scales: {
                        y: { beginAtZero: true, max: config.maxScore, title: { display: true, text: 'ì ìˆ˜' } , ticks: { precision: 0 } },
                        x: { title: { display: true, text: 'ì¸¡ì •ì¼' }, ticks: { autoSkip: true, maxTicksLimit: 7 } }
                    }
                }
            });
            
            if (config.instance === 'phqChartInstance') phqChartInstance = newInstance;
            else if (config.instance === 'gadChartInstance') gadChartInstance = newInstance;
            else if (config.instance === 'pssChartInstance') pssChartInstance = newInstance;

            return newInstance;
        }

        function updateCharts(data) {
            if (data.length === 0) {
                document.getElementById('chart-caption').textContent = "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¸¡ì •ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”!";
                if(phqChartInstance) { phqChartInstance.destroy(); phqChartInstance = null; }
                if(gadChartInstance) { gadChartInstance.destroy(); gadChartInstance = null; }
                if(pssChartInstance) { pssChartInstance.destroy(); pssChartInstance = null; }
                return;
            }

            document.getElementById('chart-caption').textContent = `ì´ ${data.length}ê±´ì˜ ì¸¡ì • ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.`;
            const labels = data.map(item => {
                if (item.timestamp) {
                    const date = item.timestamp.toDate();
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                }
                return 'N/A';
            });

            const phqScores = data.map(item => item.phq9 || null);
            const gadScores = data.map(item => item.gad7 || null);
            const pssScores = data.map(item => item.pss || null);

            createOrUpdateChart(CHART_CONFIGS.PHQ9.id, labels, phqScores, CHART_CONFIGS.PHQ9);
            createOrUpdateChart(CHART_CONFIGS.GAD7.id, labels, gadScores, CHART_CONFIGS.GAD7);
            createOrUpdateChart(CHART_CONFIGS.PSS.id, labels, pssScores, CHART_CONFIGS.PSS);
        }

        function updateSummary(data) {
            // ê° ì²™ë„ë³„ ìµœì‹  ì ìˆ˜ë¥¼ ì €ì¥í•  ê°ì²´
            const latestScores = {
                phq9: '--',
                gad7: '--',
                pss: '--'
            };

            // ë°ì´í„°ë¥¼ ì—­ìˆœìœ¼ë¡œ ìˆœíšŒí•˜ë©° ê° ì²™ë„ì˜ ì²« ë²ˆì§¸(ê°€ì¥ ìµœì‹ ) ìœ íš¨ ì ìˆ˜ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            for (let i = data.length - 1; i >= 0; i--) {
                const item = data[i];

                if (latestScores.phq9 === '--' && item.phq9 !== undefined && item.phq9 !== null) {
                    latestScores.phq9 = item.phq9;
                }
                if (latestScores.gad7 === '--' && item.gad7 !== undefined && item.gad7 !== null) {
                    latestScores.gad7 = item.gad7;
                }
                if (latestScores.pss === '--' && item.pss !== undefined && item.pss !== null) {
                    latestScores.pss = item.pss;
                }

                // ëª¨ë“  ì ìˆ˜ë¥¼ ì°¾ì•˜ìœ¼ë©´ ë°˜ë³µì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
                if (latestScores.phq9 !== '--' && latestScores.gad7 !== '--' && latestScores.pss !== '--') {
                    break;
                }
            }

            document.getElementById('latest-phq').textContent = latestScores.phq9;
            document.getElementById('latest-gad').textContent = latestScores.gad7;
            document.getElementById('latest-pss').textContent = latestScores.pss;
        }


        // --- Modal & Form Handlers ---

        let currentScale = '';

        function openAssessmentModal(scale) {
            if (!userId) {
                displayMessage('error', "ì¸¡ì •ì„ ì‹œì‘í•˜ê¸° ì „ì— ë¨¼ì € ë¡œê·¸ì¸/ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }

            currentScale = scale;
            const assessment = assessments[scale];
            
            document.getElementById('scale-title').textContent = assessment.title.split(' ')[0];
            
            const header = document.getElementById('modal-header');
            header.classList.forEach(cls => { if (cls.startsWith('bg-')) header.classList.remove(cls); });
            header.classList.add(BUTTON_COLOR_CLASS);

            const submitButton = document.getElementById('submit-assessment');
            submitButton.classList.forEach(cls => { if (cls.startsWith('bg-') || cls.startsWith('hover:bg-')) submitButton.classList.remove(cls); });
            submitButton.classList.add(BUTTON_COLOR_CLASS, BUTTON_HOVER_CLASS);

            const form = document.getElementById('assessment-form');
            form.innerHTML = '';
            
            let introText = `<p class="text-gray-600 mb-4">${assessment.questions[0]}</p>`;
            form.insertAdjacentHTML('beforeend', introText);

            const questionsToRender = scale === 'PHQ9' ? assessment.questions.slice(1, 10) : assessment.questions.slice(1);
            
            questionsToRender.forEach((questionText, index) => {
                const qNum = index + 1;
                let questionHtml = `
                    <div class="mb-5 p-4 border border-gray-200 rounded-lg shadow-sm">
                        <p class="font-semibold text-gray-800 mb-3">${questionText}</p>
                        <div class="space-y-2">
                `;
                
                assessment.options.forEach(option => {
                    const uniqueId = `${scale}-q${qNum}-v${option.value}`;
                    questionHtml += `
                        <label for="${uniqueId}" class="flex items-center p-2 bg-white rounded-md cursor-pointer hover:bg-gray-50 transition">
                            <input type="radio" id="${uniqueId}" name="q${qNum}" value="${option.value}" required class="w-4 h-4 text-sky-600 border-gray-300 focus:ring-sky-600">
                            <span class="ml-3 text-gray-700 text-sm">${option.text}</span>
                        </label>
                    `;
                });

                questionHtml += `
                        </div>
                    </div>
                `;
                form.insertAdjacentHTML('beforeend', questionHtml);
            });

            document.getElementById('assessment-modal').classList.remove('hidden');
        }

        function closeAssessmentModal() {
            document.getElementById('assessment-modal').classList.add('hidden');
            document.getElementById('assessment-form').reset();
        }

        function calculateScore(scale, formData) {
            let totalScore = 0;
            const assessment = assessments[scale];
            const numQuestionsForScoring = scale === 'PHQ9' ? 8 : assessment.questions.length - 1;

            for (let i = 1; i <= numQuestionsForScoring; i++) {
                const key = `q${i}`;
                const value = parseInt(formData.get(key));
                
                if (isNaN(value)) {
                    displayMessage('error', `'${i}ë²ˆ ì§ˆë¬¸'ì— ì‘ë‹µí•´ ì£¼ì„¸ìš”.`);
                    return null; 
                }

                if (scale === 'PSS' && assessment.reverseIndices.includes(i)) {
                    const finalScore = reverseScoreMap[value];
                    totalScore += finalScore;
                } else {
                    totalScore += value;
                }
            }
            if (scale === 'PHQ9' && isNaN(parseInt(formData.get('q9')))) {
                displayMessage('error', `'9ë²ˆ ì§ˆë¬¸'ì— ì‘ë‹µí•´ ì£¼ì„¸ìš”.`);
                return null;
            }
            
            return totalScore;
        }

        document.getElementById('assessment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const score = calculateScore(currentScale, formData);
            if (score === null) return;
            
            const result = {};
            if (currentScale === 'PHQ9') result.phq9 = score;
            else if (currentScale === 'GAD7') result.gad7 = score;
            else if (currentScale === 'PSS') result.pss = score;

            await saveAssessmentResult(result);
            closeAssessmentModal();
        });

        document.getElementById('assessment-buttons').addEventListener('click', (e) => {
            const button = e.target.closest('button[data-scale]');
            if (button) {
                openAssessmentModal(button.dataset.scale);
            }
        });

        document.getElementById('cancel-assessment').addEventListener('click', closeAssessmentModal);


        // --- Utility Functions ---

        function showLoading(isLoading) {
            const loadingDiv = document.getElementById('loading-indicator');
            if (isLoading) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }
        
    </script>
</body>
</html>
